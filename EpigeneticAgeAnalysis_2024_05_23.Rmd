---
title: "GrimAge Epigenetic Age Analysis - ComBat Batch Corrected Results"
author: "Gillian Goobie"
date: "2024_05_23"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE, echo=F}
library(tidyverse)
library(readxl)
library(parallel)
library(here)
library(knitr)
library(RColorBrewer)
library(Gviz)
library(stringr)
library(writexl)
library(psych)
library(survival)
library('dnaMethyAge')
library(qgcomp)
library(splines)
library(pspline)
library(survival)
library(survminer)
library(forestplot)
```

# Load Processed Epigenetic Age Data
```{r}
outfile1 <- here::here("CombinedCohorts_DNAmEpigeneticAge_ComBatCorrected_2024_05_23.xlsx")
dnam <- read_excel(outfile1)
```

# Create Death or Transplant Variable
```{r}
dnam <- dnam %>% mutate(deadORtx=ifelse(status==0, 0, 1))
dnam$deadORtx <- as.factor(dnam$deadORtx)
```



# Epigenetic Age Calculation
First I want to see the clock options
```{r}
availableClock()
```
HorvathS2013 is the most widely used one.
Will also compare with PCGrimAge.


## GrimAge
***I already ran this epigenetic age calculation on the UPitt cluster with the raw DNAm data.***
First need to make a dataframe for GrimAge called "age_info" which contains the Sample, Age, and Sex
```{r}
#age_info <- targetsx %>% dplyr::select(ID.x, age_dx, sex)
#age_info <- age_info %>% mutate(Sex=ifelse(sex=="M", "Male", "Female"))
#age_info <- age_info %>% rename(c("age_dx"="Age", "ID.x"="Sample"))
#age_info <- age_info %>% dplyr::select(!sex)
#age_info$Age <- round(age_info$Age, digits=0)
#str(age_info)
```


```{r}
#clock_name <- 'PCGrimAge'
#Grim_age <- methyAge(bVals, clock=clock_name, age_info = age_info)
```

```{r}
#str(Grim_age)
#Grim_age$cohort <- cohort
```
All the above chunks are ##ed out because this analysis was performed on the Pitt HTC cluster where the raw DNAm data is held. The outputs from this were exported to run on my PC.

# Creating an Epigenetic Age Difference (i.e. EAD or grim_agediff) variable
```{r}
dnam <- dnam %>% mutate(grim_agediff=mAge-age_dx)
```


# Creating Pollutant Stratification by IQR
```{r}
summary(dnam$PM_5yrPreSamp)
IQR(dnam$PM_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(PM_5yrSamp_IQR = PM_5yrPreSamp/IQR(dnam$PM_5yrPreSamp, na.rm=T))
```

```{r}
summary(dnam$SO4_5yrPreSamp)
IQR(dnam$SO4_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(SO4_5yrSamp_IQR = SO4_5yrPreSamp/IQR(dnam$SO4_5yrPreSamp, na.rm=T))
```

```{r}
summary(dnam$NO3_5yrPreSamp)
IQR(dnam$NO3_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(NO3_5yrSamp_IQR = NO3_5yrPreSamp/IQR(dnam$NO3_5yrPreSamp, na.rm=T))
```

```{r}
summary(dnam$NH4_5yrPreSamp)
IQR(dnam$NH4_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(NH4_5yrSamp_IQR = NH4_5yrPreSamp/IQR(dnam$NH4_5yrPreSamp, na.rm=T))
```

```{r}
summary(dnam$BC_5yrPreSamp)
IQR(dnam$BC_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(BC_5yrSamp_IQR = BC_5yrPreSamp/IQR(dnam$BC_5yrPreSamp, na.rm=T))
```

```{r}
summary(dnam$OM_5yrPreSamp)
IQR(dnam$OM_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(OM_5yrSamp_IQR = OM_5yrPreSamp/IQR(dnam$OM_5yrPreSamp, na.rm=T))
```

```{r}
summary(dnam$SS_5yrPreSamp)
IQR(dnam$SS_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(SS_5yrSamp_IQR = SS_5yrPreSamp/IQR(dnam$SS_5yrPreSamp, na.rm=T))
```

```{r}
summary(dnam$Soil_5yrPreSamp)
IQR(dnam$Soil_5yrPreSamp, na.rm=T)
dnam <- dnam %>% mutate(Soil_5yrSamp_IQR = Soil_5yrPreSamp/IQR(dnam$Soil_5yrPreSamp, na.rm=T))
```



# Make UPitt and UBC dataframes
Correct cohort from "CARE" to "UBC"
```{r}
dnam <- dnam %>% mutate(cohort=ifelse(cohort=="CARE", "UBC", "UPitt"))
```


```{r}
UPitt_dnam <- dnam %>% filter(cohort=="UPitt")
UBC_dnam <- dnam %>% filter(cohort=="UBC")
```


# Fix Disadvantage Scores 
Right now for the UPitt cohort patients, the score is the ADI value and for the UBC-PF patients it is the CIMD value, which cannot be analyzed together, so we need to fix that
```{r}
plot(ecdf(UPitt_dnam$disadv))
UPitt_dnam$disadv <- ecdf(UPitt_dnam$disadv)(UPitt_dnam$disadv)
```


```{r}
plot(ecdf(UBC_dnam$disadv))
UBC_dnam$disadv <- ecdf(UBC_dnam$disadv)(UBC_dnam$disadv)
```

Bind UPitt_dnam to UBC_dnam to have combined dataframe with comparable disadv scores
```{r}
dnam <- rbind(UPitt_dnam, UBC_dnam)
dnam$disadv <- 10*(dnam$disadv)
```

```{r}
summary(dnam$disadv)
IQR(dnam$disadv, na.rm=T)
dnam <- dnam %>% mutate(disadv_IQR = disadv/IQR(dnam$disadv, na.rm=T))
```


```{r}
UPitt_dnam <- dnam %>% filter(cohort=="UPitt")
UBC_dnam <- dnam %>% filter(cohort=="UBC")
```


# Creating Binned EAD 
## Dichotomized EAD
```{r}
quantile(dnam$grim_agediff, na.rm=T, probs=seq(0,1,1/4))
#We can see that the quartile cut points are 0.4410807, 9.9443219, 12.8577961, 15.7156633, 31.1766437 
dnam$grim_agediff_dich <- cut(dnam$grim_agediff,
                      breaks=c(-1, 12.8577961, 100),
                      labels=c("Low", "High"))
summary(dnam$grim_agediff_dich)
class(dnam$grim_agediff_dich)
```

## Quartiled EAD
```{r}
quantile(dnam$grim_agediff, na.rm=T, probs=seq(0,1,1/4))
#We can see that the quartile cut points are 0.4410807, 9.9443219, 12.8577961, 15.7156633, 31.1766437  
dnam$grim_agediff_quart <- cut(dnam$grim_agediff,
                      breaks=c(-1, 9.9443219, 12.8577961, 15.7156633, 100),
                      labels=c("1", "2", "3", "4"))
summary(dnam$grim_agediff_quart)
class(dnam$grim_agediff_quart)
```
# Uploading CanCOLD Data
```{r}
outfile2 <- here::here("CanCOLD_Data/CanCOLD_GrimAge_subset_2024_04_26.csv")
CanCOLD <- read.csv(outfile2)
```

```{r}
CanCOLD <- CanCOLD %>% rename("Subjectid"="ID", "SEX"="sex", "AGE"="age_dx", "DNAmGrimAge"="mAge")
```

```{r}
CanCOLD <- CanCOLD %>% mutate(dz_group=ifelse(AsthmaEver==1 & COPDEver==1, "Asthma/COPD", 
                                            ifelse(AsthmaEver==1 & COPDEver==0, "Asthma",
                                                   ifelse(COPDEver==1 & AsthmaEver==0, "COPD", "Control"))))
```

Calculate EAD for CanCOLD
```{r}
CanCOLD$grim_agediff <- CanCOLD$mAge - CanCOLD$age_dx
```

## Summarizing Function
```{r}
n_prop_tbl <- function(x) {
  tbl <- table(x)
  res <- cbind(tbl, round(prop.table(tbl)*100,2))
  colnames(res) <-  c('Count', 'Percentage')
  res
}
```

## CanCOLD Summary Data
```{r}
summary(CanCOLD$grim_agediff)
```

```{r}
summary(CanCOLD$age_dx)
```

```{r}
n_prop_tbl(CanCOLD$sex)
```

```{r}
n_prop_tbl(CanCOLD$dz_group)
```

## Make combo df for Figure 1
Add dnam to CanCOLD to combine for figure
```{r}
combo <- dnam %>% select(ID, age_dx, mAge, cohort)
combo <- combo %>% mutate(dz_group=ifelse(cohort=="UPitt", "UPitt fILD", "UBC fILD"))
CanCOLD <- CanCOLD %>% mutate(cohort="CanCOLD")
CanCOLD <- CanCOLD %>% select(ID, age_dx, mAge, cohort, dz_group)
combo <- rbind(combo, CanCOLD)
```


```{r}
combo$dz_group <- as.factor(combo$dz_group)
combo$dz_group <- fct_relevel(combo$dz_group, c("UPitt fILD", "UBC fILD", "Control", "Asthma", "COPD", "Asthma/COPD"))
```

```{r}
combo <- combo %>%
  mutate(dz_groupx = case_when(
    dz_group == "UPitt fILD" ~ "fILD",
    dz_group == "UBC fILD" ~ "fILD",
    dz_group == "Control" ~ "Control",
    dz_group == "Asthma" ~ "Obstructive Lung Disease",
    dz_group == "COPD" ~ "Obstructive Lung Disease",
    dz_group == "Asthma/COPD" ~ "Obstructive Lung Disease",
    TRUE ~ NA
  ))
```




# Plotting GrimAge
Chronological vs Methylation Age
```{r}
colors <- c("skyblue", "steelblue3", "chartreuse4", "goldenrod2", "darkorange1", "coral3")

(combo %>% ggplot(aes(x=age_dx, y=mAge, color=dz_group))+
   geom_point()+
   labs(x="Chronological Age (Years)", y="Methylation Age (Years)")+
   geom_smooth(method="lm", se = FALSE) +
   geom_abline(intercept = 0, slope = 1, linetype="dashed")+
    scale_color_manual(values = colors)+
   theme(plot.title = element_text(hjust = 0.5))+ 
    theme_light()+
   xlim(20,90)+
   ylim(20,90))
```
So we can see from this plot that our fILD patients almost invariably have a higher epigenetic age than their chronological age.
Also, UPitt patients tend to have an older epigenetic age than UBC patients. We can plot this difference in a violin plot below.

Chronological vs Methylation Age - Simpler plot
```{r}
colors <- c("chartreuse4", "steelblue3", "darkorange1")

(combo %>% ggplot(aes(x=age_dx, y=mAge, color=dz_groupx))+
   geom_point(size=0.75)+
   labs(x="Chronological Age (Years)", y="Methylation Age (Years)")+
   geom_smooth(method="lm", se = FALSE) +
   geom_abline(intercept = 0, slope = 1, linetype="dashed")+
    scale_color_manual(values = colors)+
   theme(plot.title = element_text(hjust = 0.5))+   
    theme_light()+
   xlim(20,90)+
   ylim(20,90))
```

```{r}
colors <- c("chartreuse4", "steelblue3", "darkorange1")

(combo %>% ggplot(aes(x=age_dx, y=mAge, color=dz_groupx))+
   geom_point(shape=1, size=1)+
   labs(x="Chronological Age (Years)", y="Methylation Age (Years)")+
   geom_smooth(method="lm", se = FALSE) +
   geom_abline(intercept = 0, slope = 1, linetype="dashed")+
    scale_color_manual(values = colors)+
   theme(plot.title = element_text(hjust = 0.5))+   
    theme_light()+
   xlim(20,90)+
   ylim(20,90))
```


Epigenetic Age Acceleration
```{r}
(dnam %>% ggplot(aes(x=age_dx, y=Age_Acceleration, color=cohort))+
   geom_point()+
   labs(x="Chronological Age (Years)", y="Age Acceleration")+
   geom_smooth(method="lm", se = FALSE) +
   geom_abline(intercept = 0, slope = 1, linetype="dashed")+
   theme(plot.title = element_text(hjust = 0.5)))
```

Epigenetic age by fILD diagnosis group
```{r}
(dnam %>% ggplot(aes(x=age_dx, y=mAge, color=dx_group))+
   geom_point()+
   labs(x="Chronological Age (Years)", y="Methylation Age (Years)")+
   geom_smooth(method="lm", se = FALSE) +
   geom_abline(intercept = 0, slope = 1, linetype="dashed")+
   theme(plot.title = element_text(hjust = 0.5))+    
   xlim(20,90)+
   ylim(20,90))
```
No clearly discernable difference in epigenetic age between the different diagnosis groups.

Epigenetic age difference between sexes
```{r}
(dnam %>% ggplot(aes(x=sex, y=grim_agediff, fill=sex))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Sex", y="Epigenetic Age Difference")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)))
```
Males have a greater epigenetic age difference compared with females.


Epigenetic age difference between races
```{r}
(dnam %>% ggplot(aes(x=race, y=grim_agediff, fill=race))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Race", y="Epigenetic Age Difference")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)))
```
Black patients appear to have the greates epigenetic age difference.

```{r}
dnam <- dnam %>% mutate(dx_groupx = ifelse(dx_group=="IPF", "IPF",
                                           ifelse(dx_group=="CTD-ILD", "CTD-ILD",
                                           ifelse(dx_group=="HP", "HP",
                                                  ifelse(dx_group=="OTHER_IIP", "OTHER_ILD",
                                                         ifelse(dx_group=="OTHER_ILD", "OTHER_ILD", "OTHER_ILD"))))))
dnam$dx_groupx <- fct_relevel(dnam$dx_groupx, c("IPF"))
```

Epigenetic age difference between dx_groups
```{r}
(dnam %>% ggplot(aes(x=dx_groupx, y=grim_agediff, fill=dx_groupx))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Cohort", y="Epigenetic Age Difference")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)))
```
Epigenetic age difference is high in all diagnostic groups, but most pronounced in CTD-ILD

Epigenetic age difference between dx_groups faceted by sex
```{r}
(dnam %>% ggplot(aes(x=dx_group, y=grim_agediff, fill=dx_group))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   facet_grid(~sex)+
   labs(x="Cohort", y="Epigenetic Age Difference")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)))
```
Greater epigenetic age difference in males in all diagnostic groups

Epigenetic age difference between cohorts by dx_group
```{r}
(dnam %>% ggplot(aes(x=cohort, y=grim_agediff, fill=cohort))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   facet_grid(~dx_group)+
   labs(x="Cohort", y="Epigenetic Age Difference")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)))
```
All major dx_groups demonstrate a higher epigenetic age difference in UPitt compared with UBC


## Epigenetic Age Difference by Cohort
```{r}
(dnam %>% ggplot(aes(x=cohort, y=grim_agediff, fill=cohort))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Cohort", y="Epigenetic Age Difference by Cohort")+
   theme(plot.title = element_text(hjust = 0.5)))
```
UPitt has a much larger epigenetic age difference than UBC.


Epigenetic age difference by cohort, faceted by sex
```{r}
(dnam %>% ggplot(aes(x=cohort, y=grim_agediff, fill=cohort))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   facet_grid(~sex)+
   labs(x="Cohort", y="Epigenetic Age Difference")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)))
```
Bigger epigenetic age difference between the cohorts in males compared with females

# Summary Data

## Sex Breakdown
```{r}
n_prop_tbl(UPitt_dnam$sex)
n_prop_tbl(UBC_dnam$sex)
n_prop_tbl(dnam$sex)
```

## Race Breakdown
```{r}
n_prop_tbl(UPitt_dnam$race)
n_prop_tbl(UBC_dnam$race)
n_prop_tbl(dnam$race)
```

```{r}
n_prop_tbl(UPitt_dnam$dich_Race)
n_prop_tbl(UBC_dnam$dich_Race)
n_prop_tbl(dnam$dich_Race)
```

## Smoking History Breakdown
```{r}
n_prop_tbl(UPitt_dnam$smokeHx)
n_prop_tbl(UBC_dnam$smokeHx)
n_prop_tbl(dnam$smokeHx)
```

## Dx_Group Breakdown
```{r}
n_prop_tbl(UPitt_dnam$dx_group)
n_prop_tbl(UBC_dnam$dx_group)
n_prop_tbl(dnam$dx_group)
```

## Status Breakdown
```{r}
n_prop_tbl(UPitt_dnam$status)
n_prop_tbl(UBC_dnam$status)
n_prop_tbl(dnam$status)
```

## Age_dx Breakdown
```{r}
summary(UPitt_dnam$age_dx)
shapiro.test(UPitt_dnam$age_dx)
summary(UBC_dnam$age_dx)
shapiro.test(UBC_dnam$age_dx)
summary(dnam$age_dx)
sd(dnam$age_dx)
shapiro.test(dnam$age_dx)
```

## Baseline FVC Breakdown
```{r}
summary(UPitt_dnam$fvc_pct)
shapiro.test(UPitt_dnam$fvc_pct)
summary(UBC_dnam$fvc_pct)
shapiro.test(UBC_dnam$fvc_pct)
summary(dnam$fvc_pct)
shapiro.test(dnam$fvc_pct)
```

## Baseline DLCO Breakdown
```{r}
summary(UPitt_dnam$dlco_pct)
shapiro.test(UPitt_dnam$dlco_pct)
summary(UBC_dnam$dlco_pct)
shapiro.test(UBC_dnam$dlco_pct)
summary(dnam$dlco_pct)
shapiro.test(dnam$dlco_pct)
```

## ECDF Disadvantage Score Breakdown
```{r}
summary(UPitt_dnam$disadv)
shapiro.test(UPitt_dnam$disadv)
summary(UBC_dnam$disadv)
shapiro.test(UBC_dnam$disadv)
summary(dnam$disadv)
shapiro.test(dnam$disadv)
```

## Time to Censoring Breakdown
```{r}
summary(UPitt_dnam$time_DeathTxCensor)
shapiro.test(UPitt_dnam$time_DeathTxCensor)
summary(UBC_dnam$time_DeathTxCensor)
shapiro.test(UBC_dnam$time_DeathTxCensor)
summary(dnam$time_DeathTxCensor)
shapiro.test(dnam$time_DeathTxCensor)
```

## Epigenetic Age Difference Breakdown
```{r}
summary(UPitt_dnam$grim_agediff)
shapiro.test(UPitt_dnam$grim_agediff)
summary(UBC_dnam$grim_agediff)
shapiro.test(UBC_dnam$grim_agediff)
summary(dnam$grim_agediff)
shapiro.test(dnam$grim_agediff)
```


# Visual EDA for Pollution-Epigenetic Age Difference Association
## PM2.5
Epigenetic age difference by PM2.5 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=PM_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="PM2.5 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Pretty strong upwards correlation between increasing PM2.5 and increasing methylation age difference

Epigenetic age difference by PM2.5 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=PM_5yrPreSamp, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="PM2.5 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Pretty strong upwards correlation between increasing PM2.5 and increasing methylation age difference in IPF, fHP, Unclassifiable ILD, and to a lesser extent CTD-ILD


## SO4
Epigenetic age difference by SO4 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=SO4_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="SO4 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Pretty strong upwards correlation between increasing SO4 and increasing methylation age difference in UPitt

Epigenetic age difference by SO4 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=SO4_5yrPreSamp, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="SO4 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Pretty strong upwards correlation between increasing SO4 and increasing methylation age difference in IPF, fHP, Unclassifiable ILD, and to a lesser extent CTD-ILD


## NO3
Epigenetic age difference by NO3 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=NO3_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="NO3 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Pretty strong upwards correlation between increasing NO3 and increasing methylation age difference in UPitt and to lesser extent UBC-PF

Epigenetic age difference by NO3 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=NO3_5yrPreSamp, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="NO3 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Strong upward trend for all dx_groups

## NH4
Epigenetic age difference by NH4 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=NH4_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="NH4 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Pretty strong upwards correlation between increasing NH4 and increasing methylation age difference

Epigenetic age difference by NH4 exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=NH4_5yrPreSamp, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="NH4 in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Strong upward trend for most dx groups

## BC
Epigenetic age difference by BC exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=BC_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="BC in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Fairly strong upwards correlation between increasing BC and increasing methylation age difference

Epigenetic age difference by BC exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=BC_5yrPreSamp, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="BC in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Upward trend for most dx_groups

## OM
Epigenetic age difference by OM exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=OM_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="OM in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Slight upwards correlation between increasing OM and increasing methylation age difference

Epigenetic age difference by OM exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=OM_5yrPreSamp, colour=dx_group))+ 
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="OM in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Upward trend for most dx_groups except Unclassifiable

## SS
Epigenetic age difference by SS exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=SS_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="SS in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
No clear trend, even downwards in UBC

Epigenetic age difference by SS exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=SS_5yrPreSamp, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="SS in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Fairly clear downward trend for all dx_groups

## Soil
Epigenetic age difference by Soil exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=Soil_5yrPreSamp, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="Soil in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Slight upwards correlation between increasing Soil and increasing methylation age difference

Epigenetic age difference by Soil exposure in 5yrs pre-sampling
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=Soil_5yrPreSamp, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="Soil in 5yrs Pre-Sampling" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Slight upward trend for all dx_groups

# Visual EDA Disadvantage-Epigenetic Age Association
## UPitt
Epigenetic age difference by Disadvantage Score in UPitt
```{r}
UPitt_dnam <- dnam %>% filter(cohort=="UPitt")
(UPitt_dnam %>% ggplot(aes(x=grim_agediff, y=disadv))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="Disadvantage Score")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Appears to be increasing association between epigenetic age and ADI in the UPitt cohort

Epigenetic age difference by disadv score
```{r}
(UPitt_dnam %>% ggplot(aes(x=grim_agediff, y=disadv, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="Disadvantage Score" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
Upward trend for all dx_groups, except fHP

## UBC
Epigenetic age difference by Disadvantage Score in UBC
```{r}
UBC_dnam <- dnam %>% filter(cohort=="UBC")
(UBC_dnam %>% ggplot(aes(x=grim_agediff, y=disadv))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="Disadvantage Score")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
No clear association between epigenetic age and CIMD in the UBC cohort

Epigenetic age difference by disadv score
```{r}
(UBC_dnam %>% ggplot(aes(x=grim_agediff, y=disadv, colour=dx_group))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="Disadvantage Score" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```
No clear association between epigenetic age and CIMD in the UBC cohort


## Combined Cohorts
```{r}
(dnam %>% ggplot(aes(x=grim_agediff, y=disadv, colour=cohort))+
   geom_point()+
   labs(x="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)", y="Disadvantage Score" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```

# Visual EDA of EAD Assoc with Baseline FVC
## Combined Cohorts
```{r}
(dnam %>% ggplot(aes(x=fvc_pct, y=grim_agediff, colour=cohort))+
   geom_point()+
   labs(x="Baseline FVC % Pred", y="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```

# Visual EDA of EAD Assoc with Baseline DLCO
## Combined Cohorts
```{r}
(dnam %>% ggplot(aes(x=dlco_pct, y=grim_agediff, colour=cohort))+
   geom_point()+
   labs(x="Baseline DLCO % Pred", y="Epigenetic Age Difference \n(Methylation Age - Chronological Age, Years)" )+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5)))
```

# Age at Diagnosis by Epigenetic Age Difference
## UPitt
### Continuous EAD
```{r}
age_model1 <- lm(age_dx ~ grim_agediff, data=UPitt_dnam)
summary(age_model1)
confint(age_model1)
```
**Significant assoc between epigenetic age difference and earlier age at diagnosis - i.e. each 1 year increase in EAD associated with 1.66yrs early age_dx.**

```{r}
age_model2 <- lm(age_dx ~ grim_agediff + sex + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(age_model2)
confint(age_model2)
```
**Significant assoc between epigenetic age difference and earlier age at diagnosis - i.e. each 1 year increase in EAD associated with 1.89yrs early age_dx.**

## UBC
### Continuous EAD
```{r}
age_model1 <- lm(age_dx ~ grim_agediff, data=UBC_dnam)
summary(age_model1)
confint(age_model1)
```
**Significant assoc between epigenetic age difference and earlier age at diagnosis - i.e. each 1 year increase in EAD associated with 2.01yrs early age_dx.**

```{r}
age_model2 <- lm(age_dx ~ grim_agediff + sex + smokeHx + dich_Race + disadv + dx_IPF, data=UBC_dnam)
summary(age_model2)
confint(age_model2)
```
**Significant assoc between epigenetic age difference and earlier age at diagnosis - i.e. each 1 year increase in EAD associated with 1.98yrs early age_dx.**

## Combined Cohorts
### Continuous EAD
```{r}
age_model1 <- lm(age_dx ~ grim_agediff + cluster(cohort), data=dnam)
summary(age_model1)
confint(age_model1)
```
**Significant assoc between epigenetic age difference and earlier age at diagnosis - i.e. each 1 year increase in EAD associated with 1.76yrs early age_dx.**

```{r}
age_model2 <- lm(age_dx ~ grim_agediff + sex + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), data=dnam)
summary(age_model2)
confint(age_model2)
```
**Significant assoc between epigenetic age difference and earlier age at diagnosis - i.e. each 1 year increase in EAD associated with 1.93yrs earlier age_dx.**



# Survival by Epigenetic Age Difference
## UPitt
### Continuous EAD
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx, data=UPitt_dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher grim_agediff is significantly assoc with increased mortality. Interpret this as for each 1 year increase in epigenetic age difference, there is an 11% increased risk of mortality.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF, data=UPitt_dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**Adjusting for other covariates, there is a strong association between grim_agediff and mortality, indicating that for each 1 year increase in epigenetic age difference, there is an 8% increased risk of mortality!**

Adjusted Model + Lung Function
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct, data=UPitt_dnam, id=EPIC_ID)
summary(coxPH_model3)
```
Adjusting for other covariates + lung function, we lose the association between grim_agediff and mortality, indicating that the effect is mediated in part through lung function


## UBC
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx, data=UBC_dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher grim_agediff is significantly assoc with increased mortality. Interpret this as for each 1 year increase in epigenetic age difference, there is a 34% increased risk of mortality.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF, data=UBC_dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**Adjusting for other covariates, there is a strong association between grim_agediff and mortality, indicating that for each 1 year increase in epigenetic age difference, there is a 30% increased risk of mortality!**


Adjusted Model + Lung Function
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct, data=UBC_dnam, id=EPIC_ID)
summary(coxPH_model3)
```
**Adjusting for other covariates + lung function, there is a strong association between grim_agediff and mortality, indicating that for each 1 year increase in epigenetic age difference, there is a 27% increased risk of mortality**

## Combined Cohorts
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher grim_agediff is significantly assoc with increased mortality. Interpret this as for each 1 year increase in epigenetic age difference, there is a 16% increased risk of mortality.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**Adjusting for other covariates, there is a strong association between grim_agediff and mortality, indicating that for each 1 year increase in epigenetic age difference, there is a 13% increased risk of mortality!**



Adjusted Model + Lung Function
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct, data=dnam, id=EPIC_ID)
summary(coxPH_model3)
```
**Adjusting for other covariates, there is a strong association between grim_agediff and mortality, indicating that for each 1 year increase in epigenetic age difference, there is an 8% increased risk of mortality!**

## Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
dnamx <- dnam %>% filter(!is.na(grim_agediff) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(cohort))

#Then make survival function
surv1 <- Surv(dnamx$time_DeathTxCensor, dnamx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(dnamx$grim_agediff, df=3) + cluster(dnamx$cohort))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(dnamx$grim_agediff, exp(predicted$fit), type="n", xlim=c(0,20), ylim=c(0,1.3))
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Coviariate adjusted model
```{r}
#First need to make dataframe that only includes patients with a value for event
dnamx <- dnam %>% filter(!is.na(grim_agediff) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(cohort) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(dx_IPF))

#Then make survival function
surv1 <- Surv(dnamx$time_DeathTxCensor, dnamx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(dnamx$grim_agediff, df=3) + dnamx$age_dx + dnamx$sex + dnamx$smokeHx + dnamx$dich_Race + dnamx$dx_IPF + cluster(dnamx$cohort))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(dnamx$grim_agediff, exp(predicted$fit), type="n", xlim=c(0,20), ylim=c(0,3))
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```


Coviariate + lung funciton adjusted model
```{r}
#First need to make dataframe that only includes patients with a value for event
dnamx <- dnam %>% filter(!is.na(grim_agediff) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(cohort) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(dx_IPF) &!is.na(fvc_pct) & !is.na(dlco_pct))

#Then make survival function
surv1 <- Surv(dnamx$time_DeathTxCensor, dnamx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(dnamx$grim_agediff, df=3) + dnamx$age_dx + dnamx$sex + dnamx$smokeHx + dnamx$dich_Race + dnamx$dx_IPF + dnamx$fvc_pct + dnamx$dlco_pct + cluster(dnamx$cohort))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(dnamx$grim_agediff, exp(predicted$fit), type="n", xlim=c(0,25), ylim=c(0,3))
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(dnamx$grim_agediff, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

### Dichotomized EAD
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff_dich + age_dx + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher grim_agediff is significantly assoc with increased mortality. Interpret this as compared to the Low EAD group, the High EAD group has a 2.37x increased risk of mortality when you account for baseline age.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff_dich + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**When we account for age_dx, higher grim_agediff is significantly assoc with increased mortality. Interpret this as compared to the Low EAD group, the High EAD group has a 1.73x increased risk of mortality when you account for baseline age.**

Adjusted + Baseline Lung Function Model
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff_dich + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model3)
```
When we account for baseline FVC and DLCO, higher grim_agediff is no longer significantly associated with mortality



Now I will make a Kaplan-Meier survival curve, discretized by dichotomized EAD:
```{r, fig.height=5, fig.width=7}
surv1 <- survfit(Surv(time_DeathTxCensor, deadORtx==1) ~grim_agediff_dich, data=dnam)
(ggsurvplot(surv1, 
            censor=TRUE,
            pval=TRUE,
            xlim=c(0,10),
            legend="right",
           data=dnam,
           legend.title="Low vs High EAD",
           legend.labs=c("Low", "High"),
           risk.table=F,
           title="Time to Death or Transplant by EAD Quartile",
           xlab="Time from Diagnosis (years)",
           ylab="Survival Probability (Death or Lung Transplant)",
           ggtheme = theme_grey()
           ))
```

### Quartiled EAD
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff_quart + age_dx + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher grim_agediff Q2-4 are significantly assoc with increased mortality. Interpret this as compared to the lowest EAD group Q1, the highest EAD group Q4 has a 4.92x increased risk of mortality when you account for baseline age.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff_quart + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**When we account for age_dx, higher grim_agediff Q2-4 are significantly assoc with increased mortality. Interpret this as compared to the lowest EAD group Q1, the highest EAD group Q4 has a 3.52x increased risk of mortality when you account for baseline age.**


Adjusted + Baseline Lung Function Model
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ grim_agediff_quart + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model3)
```
**When we account for age_dx, higher grim_agediff Q2-4 are significantly assoc with increased mortality. Interpret this as compared to the lowest EAD group Q1, the highest EAD group Q4 has a 2.03x increased risk of mortality when you account for baseline age.**


Now I will make a Kaplan-Meier survival curve, discretized by EAD quartiles:
```{r, fig.height=5, fig.width=7}
surv1 <- survfit(Surv(time_DeathTxCensor, deadORtx==1) ~grim_agediff_quart, data=dnam)
(ggsurvplot(surv1, 
            palette="YlOrRd",
            censor=TRUE,
            pval=TRUE,
            xlim=c(0,10),
            legend="right",
           data=dnam,
           legend.title="EAD Quartile",
           legend.labs=c("Q1", "Q2", "Q3", "Q4"),
           risk.table=F,
           title="Time to Death or Transplant by EAD Quartile",
           xlab="Time from Diagnosis (years)",
           ylab="Survival Probability (Death or Lung Transplant)",
           ggtheme = theme_grey()
           ))
```



# Age Diff Assoc with Baseline FVC
## UPitt
```{r}
FVC_model1 <- lm(fvc_pct ~ grim_agediff + age_dx, data=UPitt_dnam)
summary(FVC_model1)
confint(FVC_model1)
```
No significant assoc between epigenetic age difference and baseline FVC

```{r}
FVC_model2 <- lm(fvc_pct ~ grim_agediff + age_dx + sex + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(FVC_model2)
confint(FVC_model2)
```
No significant assoc between epigenetic age difference and baseline FVC


## UBC
```{r}
FVC_model1 <- lm(fvc_pct ~ grim_agediff + age_dx, data=UBC_dnam)
summary(FVC_model1)
confint(FVC_model1)
```
No significant assoc between epigenetic age difference and baseline FVC

```{r}
FVC_model2 <- lm(fvc_pct ~ grim_agediff + age_dx + sex + smokeHx + dich_Race + disadv + dx_IPF, data=UBC_dnam)
summary(FVC_model2)
confint(FVC_model2)
```
No significant assoc between epigenetic age difference and baseline FVC


## Combined Cohort
### Continuous models
```{r}
FVC_model1 <- lm(fvc_pct ~ grim_agediff + age_dx + cluster(cohort), data=dnam)
summary(FVC_model1)
confint(FVC_model1)
```
No significant assoc between epigenetic age difference and baseline FVC

```{r}
FVC_model2 <- lm(fvc_pct ~ grim_agediff + age_dx + cluster(cohort) + sex + smokeHx + dich_Race + disadv + dx_IPF , data=dnam)
summary(FVC_model2)
confint(FVC_model2)
```
No significant assoc between epigenetic age difference and baseline FVC



# Age Diff Assoc with Baseline DLCO
## UPitt
```{r}
DLCO_model1 <- lm(dlco_pct ~ grim_agediff + age_dx, data=UPitt_dnam)
summary(DLCO_model1)
confint(DLCO_model1)
```
**Significant assoc between higher epigenetic age diff and lower baseline DLCO, indicating that each 1yr increase epigenetic age assoc with -0.75% lower baseline DLCO.**

```{r}
DLCO_model2 <- lm(dlco_pct ~ grim_agediff + age_dx + sex + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(DLCO_model2)
confint(DLCO_model2)
```
**Significant assoc between higher epigenetic age diff and lower baseline DLCO, indicating that each 1yr increase epigenetic age assoc with -1.44% lower baseline DLCO.**

## UBC
```{r}
DLCO_model1 <- lm(dlco_pct ~ grim_agediff + age_dx, data=UBC_dnam)
summary(DLCO_model1)
confint(DLCO_model1)
```
**Significant assoc between higher epigenetic age diff and lower baseline DLCO, indicating that each 1yr increase epigenetic age assoc with -1.71% lower baseline DLCO.**

```{r}
DLCO_model2 <- lm(dlco_pct ~ grim_agediff + age_dx + sex + smokeHx + dich_Race + disadv + dx_IPF, data=UBC_dnam)
summary(DLCO_model2)
confint(DLCO_model2)
```
**Significant assoc between higher epigenetic age diff and lower baseline DLCO, indicating that each 1yr increase epigenetic age assoc with -1.48% lower baseline DLCO.**



## Combined Cohort
### Continuous models
```{r}
DLCO_model1 <- lm(dlco_pct ~ grim_agediff + age_dx + cluster(cohort), data=dnam)
summary(DLCO_model1)
confint(DLCO_model1)
```
**Significant assoc between higher epigenetic age diff and lower baseline DLCO, indicating that each 1yr increase epigenetic age assoc with -1.02% lower baseline DLCO.**

```{r}
DLCO_model2 <- lm(dlco_pct ~ grim_agediff + age_dx + cluster(cohort) + sex + smokeHx + dich_Race + disadv + dx_IPF , data=dnam)
summary(DLCO_model2)
confint(DLCO_model2)
```
**Significant assoc between higher epigenetic age diff and lower baseline DLCO, indicating that each 1yr increase epigenetic age assoc with -1.31% lower baseline DLCO.**


# Pollutant Associations with Epigenetic Age Diff
## PM2.5 in 5yrs Pre-Sampling
### UPitt Alone
```{r}
PM_model1 <- lm(grim_agediff ~ PM_5yrPreSamp, data=UPitt_dnam)
summary(PM_model1)
confint(PM_model1)
```
**Significant assoc between higher PM2.5 exposure and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr PM2.5 assoc with 0.26 years increased epigenetic age diff.**


```{r}
PM_model2 <- lm(grim_agediff ~ PM_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(PM_model2)
confint(PM_model2)
```
**Sig assoc between higher PM2.5 exposure and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr PM2.5 assoc with 0.26 years increased epigenetic age diff.**


### UBC Alone
```{r}
PM_model1 <- lm(grim_agediff ~ PM_5yrPreSamp, data=UBC_dnam)
summary(PM_model1)
confint(PM_model1)
```
No significant assoc between higher PM2.5 exposure and epigenetic age difference in UBC cohort, but effect size the same as Pitt.


```{r}
PM_model2 <- lm(grim_agediff ~ PM_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(PM_model2)
confint(PM_model2)
```
No significant assoc between higher PM2.5 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
PM_model1 <- lm(grim_agediff ~ PM_5yrPreSamp + cluster(cohort), data=dnam)
summary(PM_model1)
confint(PM_model1)
```
**Significant assoc between highere PM2.5 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr PM2.5 assoc with 0.26 years increased epigenetic age diff.**


```{r}
PM_model2 <- lm(grim_agediff ~ PM_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(PM_model2)
confint(PM_model2)
```
**Sig assoc between higher PM2.5 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr PM2.5 assoc with 0.26 years increased epigenetic age diff.**


## SO4 in 5yrs Pre-Sampling
### UPitt Alone
```{r}
SO4_model1 <- lm(grim_agediff ~ SO4_5yrPreSamp, data=UPitt_dnam)
summary(SO4_model1)
confint(SO4_model1)
```
*Marginal assoc between higher SO4 exposure in 5yrs pre-sampling and 0.39 years increased epigenetic age difference.*


```{r}
SO4_model2 <- lm(grim_agediff ~ SO4_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(SO4_model2)
confint(SO4_model2)
```
*Marginal assoc between higher SO4 exposure in 5yrs pre-sampling and 0.37 years increased epigenetic age difference.*


### UBC Alone
```{r}
SO4_model1 <- lm(grim_agediff ~ SO4_5yrPreSamp, data=UBC_dnam)
summary(SO4_model1)
confint(SO4_model1)
```
No significant assoc between higher SO4 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
SO4_model2 <- lm(grim_agediff ~ SO4_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(SO4_model2)
confint(SO4_model2)
```
No significant assoc between higher SO4 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
SO4_model1 <- lm(grim_agediff ~ SO4_5yrPreSamp + cluster(cohort), data=dnam)
summary(SO4_model1)
confint(SO4_model1)
```
**Sig assoc between higher SO4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr SO4 assoc with 0.40 years increased epigenetic age diff.**


```{r}
SO4_model2 <- lm(grim_agediff ~ SO4_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(SO4_model2)
confint(SO4_model2)
```
**Sig assoc between higher SO4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr SO4 assoc with 0.39 years increased epigenetic age diff.**



## NO3 in 5yrs Pre-Sampling
### UPitt Alone
```{r}
NO3_model1 <- lm(grim_agediff ~ NO3_5yrPreSamp, data=UPitt_dnam)
summary(NO3_model1)
confint(NO3_model1)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NO3 assoc with 2.20 years increased epigenetic age diff.**


```{r}
NO3_model2 <- lm(grim_agediff ~ NO3_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(NO3_model2)
confint(NO3_model2)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NO3 assoc with 2.14 years increased epigenetic age diff.**


### UBC Alone
```{r}
NO3_model1 <- lm(grim_agediff ~ NO3_5yrPreSamp, data=UBC_dnam)
summary(NO3_model1)
confint(NO3_model1)
```
No significant assoc between higher NO3 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
NO3_model2 <- lm(grim_agediff ~ NO3_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(NO3_model2)
confint(NO3_model2)
```
No significant assoc between higher NO3 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
NO3_model1 <- lm(grim_agediff ~ NO3_5yrPreSamp + cluster(cohort), data=dnam)
summary(NO3_model1)
confint(NO3_model1)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NO3 assoc with 2.25 years increased epigenetic age diff.**


```{r}
NO3_model2 <- lm(grim_agediff ~ NO3_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(NO3_model2)
confint(NO3_model2)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NO3 assoc with 2.18 years increased epigenetic age diff.**


## NH4 in 5yrs Pre-Sampling
### UPitt Alone
```{r}
NH4_model1 <- lm(grim_agediff ~ NH4_5yrPreSamp, data=UPitt_dnam)
summary(NH4_model1)
confint(NH4_model1)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NH4 assoc with 1.44 years increased epigenetic age diff.**


```{r}
NH4_model2 <- lm(grim_agediff ~ NH4_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(NH4_model2)
confint(NH4_model2)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NH4 assoc with 1.39 years increased epigenetic age diff.**


### UBC Alone
```{r}
NH4_model1 <- lm(grim_agediff ~ NH4_5yrPreSamp, data=UBC_dnam)
summary(NH4_model1)
confint(NH4_model1)
```
*Marginal assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NH4 assoc with 12.53 years increased epigenetic age diff.*


```{r}
NH4_model2 <- lm(grim_agediff ~ NH4_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(NH4_model2)
confint(NH4_model2)
```
*Marginal assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NH4 assoc with 13.68 years increased epigenetic age diff.*

### Combined Cohorts
```{r}
NH4_model1 <- lm(grim_agediff ~ NH4_5yrPreSamp + cluster(cohort), data=dnam)
summary(NH4_model1)
confint(NH4_model1)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NH4 assoc with 1.50 years increased epigenetic age diff.**


```{r}
NH4_model2 <- lm(grim_agediff ~ NH4_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(NH4_model2)
confint(NH4_model2)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr NH4 assoc with 1.48 years increased epigenetic age diff.**


## BC in 5yrs Pre-Sampling
### UPitt Alone
```{r}
BC_model1 <- lm(grim_agediff ~ BC_5yrPreSamp, data=UPitt_dnam)
summary(BC_model1)
confint(BC_model1)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr BC assoc with 5.32 years increased epigenetic age diff.**


```{r}
BC_model2 <- lm(grim_agediff ~ BC_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(BC_model2)
confint(BC_model2)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr BC assoc with 5.24 years increased epigenetic age diff.**


### UBC Alone
```{r}
BC_model1 <- lm(grim_agediff ~ BC_5yrPreSamp, data=UBC_dnam)
summary(BC_model1)
confint(BC_model1)
```
No significant assoc between higher BC exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
BC_model2 <- lm(grim_agediff ~ BC_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(BC_model2)
confint(BC_model2)
```
No significant assoc between higher BC exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
BC_model1 <- lm(grim_agediff ~ BC_5yrPreSamp + cluster(cohort), data=dnam)
summary(BC_model1)
confint(BC_model1)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr BC assoc with 3.47 years increased epigenetic age diff.**


```{r}
BC_model2 <- lm(grim_agediff ~ BC_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(BC_model2)
confint(BC_model2)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr BC assoc with 3.23 years increased epigenetic age diff.**


## OM in 5yrs Pre-Sampling
### UPitt Alone
```{r}
OM_model1 <- lm(grim_agediff ~ OM_5yrPreSamp, data=UPitt_dnam)
summary(OM_model1)
confint(OM_model1)
```
**Significant assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr OM assoc with 1.21 years increased epigenetic age diff.**


```{r}
OM_model2 <- lm(grim_agediff ~ OM_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(OM_model2)
confint(OM_model2)
```
**Significant assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr OM assoc with 1.13 years increased epigenetic age diff.**


### UBC Alone
```{r}
OM_model1 <- lm(grim_agediff ~ OM_5yrPreSamp, data=UBC_dnam)
summary(OM_model1)
confint(OM_model1)
```
No significant assoc between higher OM exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
OM_model2 <- lm(grim_agediff ~ OM_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(OM_model2)
confint(OM_model2)
```
No significant assoc between higher OM exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
OM_model1 <- lm(grim_agediff ~ OM_5yrPreSamp + cluster(cohort), data=dnam)
summary(OM_model1)
confint(OM_model1)
```
**Significant assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr OM assoc with 0.47 years increased epigenetic age diff.**


```{r}
OM_model2 <- lm(grim_agediff ~ OM_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(OM_model2)
confint(OM_model2)
```
**Sig assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr OM assoc with 0.41 years increased epigenetic age diff.**


## SS in 5yrs Pre-Sampling
### UPitt Alone
```{r}
SS_model1 <- lm(grim_agediff ~ SS_5yrPreSamp, data=UPitt_dnam)
summary(SS_model1)
confint(SS_model1)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and epigenetic age difference.


```{r}
SS_model2 <- lm(grim_agediff ~ SS_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(SS_model2)
confint(SS_model2)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and epigenetic age difference.


### UBC Alone
```{r}
SS_model1 <- lm(grim_agediff ~ SS_5yrPreSamp, data=UBC_dnam)
summary(SS_model1)
confint(SS_model1)
```
*Marginal assoc between higher SS exposure in 5yrs pre-sampling and lower epigenetic age difference in UBC cohort, indicating that each 1ug/m3 increase in SS is associated with a 4.20 year lower EAD.*


```{r}
SS_model2 <- lm(grim_agediff ~ SS_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(SS_model2)
confint(SS_model2)
```
*Marginal assoc between higher SS exposure in 5yrs pre-sampling and lower epigenetic age difference in UBC cohort, indicating that each 1ug/m3 increase in SS is associated with a 4.46 year lower EAD.*

### Combined Cohorts
```{r}
SS_model1 <- lm(grim_agediff ~ SS_5yrPreSamp + cluster(cohort), data=dnam)
summary(SS_model1)
confint(SS_model1)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and  epigenetic age difference.


```{r}
SS_model2 <- lm(grim_agediff ~ SS_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(SS_model2)
confint(SS_model2)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and  epigenetic age difference.


## Soil in 5yrs Pre-Sampling
### UPitt Alone
```{r}
Soil_model1 <- lm(grim_agediff ~ Soil_5yrPreSamp, data=UPitt_dnam)
summary(Soil_model1)
confint(Soil_model1)
```
*Marginal assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr Soil assoc with 4.03 years increased epigenetic age diff.*


```{r}
Soil_model2 <- lm(grim_agediff ~ Soil_5yrPreSamp + dich_Race + disadv, data=UPitt_dnam)
summary(Soil_model2)
confint(Soil_model2)
```
*Marginal assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr Soil assoc with 3.97 years increased epigenetic age diff.*


### UBC Alone
```{r}
Soil_model1 <- lm(grim_agediff ~ Soil_5yrPreSamp, data=UBC_dnam)
summary(Soil_model1)
confint(Soil_model1)
```
No significant assoc between higher Soil exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
Soil_model2 <- lm(grim_agediff ~ Soil_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)
summary(Soil_model2)
confint(Soil_model2)
```
No significant assoc between higher Soil exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
Soil_model1 <- lm(grim_agediff ~ Soil_5yrPreSamp + cluster(cohort), data=dnam)
summary(Soil_model1)
confint(Soil_model1)
```
**Significant assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr Soil assoc with 4.43 years increased epigenetic age diff.**


```{r}
Soil_model2 <- lm(grim_agediff ~ Soil_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)
summary(Soil_model2)
confint(Soil_model2)
```
**Significant assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1ug/m3 increase 5yr Soil assoc with 4.33 years increased epigenetic age diff.**


## Forest Plots for Pollutant Assoc with EAD
### PM2.5, SO4, NO3, and NH4
```{r}
EAD <- structure(list(mean=c(NA, NA, 0.24, 0.21, 0.24, NA, 0.32, 2.54, 0.34, NA, 2.14, 2.09, 2.11, NA, 1.25, 12.76, 1.33),
                      lower=c(NA, NA, 0.02, -0.35, 0.04, NA, -0.08, -3.62, -0.05, NA, 0.57, -2.30, 0.67, NA, 0.15, -1.17, 0.28),
                      upper=c(NA, NA,  0.46, 0.78, 0.44, NA, 0.73, 8.70, 0.73, NA, 3.72, 6.49, 3.55, NA, 2.35, 26.69, 2.38)),
                 .Names=c("mean","lower","upper"),
                 row.names=c(NA, -11L),
                 class="data.frame")

tabletext <- cbind(c("  Pollutant", "PM2.5", "  UPitt", "  UBC", "  Combined", "SO4", "  UPitt", "  UBC", "  Combined", "NO3", "  UPitt", "  UBC", "  Combined", "NH4", "  UPitt", "  UBC", "  Combined"),
                   c("Beta (95% CI)", "", "0.24 (0.02 to 0.46)", "0.21 (-0.35 to 0.78)", "0.24 (0.04 to 0.44)", "", "0.32 (-0.08 to 0.73)", "2.54 (-3.62 to 8.70)", "0.34 (-0.05 to 0.73)", "", "2.14 (0.57 to 3.72)", "2.09(-2.30 to 6.49)", "2.11 (0.67 to 3.55)", "", "1.25 (0.15 to 2.35)", "12.76 (-1.17 to 26.69)", "1.33 (0.28 to 2.38)"),
                   c("P-value", "", "0.03", "0.45", "0.02", "", "0.12", "0.41", "0.09", "", "0.03", "0.87", "0.002", "", "0.03", "0.07", "0.01"))


EAD %>% forestplot(labeltext = tabletext, 
             is.summary = c(rep(TRUE, 2), rep(FALSE, 3), TRUE, rep(FALSE, 3), TRUE, rep(FALSE, 3), TRUE, rep(FALSE, 3)),
             clip = c(-4, 15), 
             col = fpColors(box = "royalblue",
                            line = "darkblue",
                           summary = "royalblue"),
             boxsize=0.3,
             angle=45)
```



# Pollutant IQR Associations with Epigenetic Age Diff
## PM2.5 IQR in 5yrs Pre-Sampling
### UPitt Alone
```{r}
PM_model1 <- lm(grim_agediff ~ PM_5yrSamp_IQR, data=UPitt_dnam)
summary(PM_model1)
confint(PM_model1)
```
**Significant assoc between higher PM2.5 exposure and higher epigenetic age difference. I.e. each 1 IQR increase 5yr PM2.5 assoc with 1.88 years increased epigenetic age diff.**


```{r}
PM_model2 <- lm(grim_agediff ~ PM_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(PM_model2)
confint(PM_model2)
```
**Sig assoc between higher PM2.5 exposure and higher epigenetic age difference. I.e. each 1 IQR increase 5yr PM2.5 assoc with 1.86 years increased epigenetic age diff.**


### UBC Alone
```{r}
PM_model1 <- lm(grim_agediff ~ PM_5yrSamp_IQR, data=UBC_dnam)
summary(PM_model1)
confint(PM_model1)
```
No significant assoc between higher PM2.5 exposure and epigenetic age difference in UBC cohort.


```{r}
PM_model2 <- lm(grim_agediff ~ PM_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(PM_model2)
confint(PM_model2)
```
No significant assoc between higher PM2.5 exposure in 5yrs pre-sampling and epigenetic age difference in UBC cohort.

### Combined Cohorts
```{r}
PM_model1 <- lm(grim_agediff ~ PM_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(PM_model1)
confint(PM_model1)
```
**Significant assoc between highere PM2.5 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr PM2.5 assoc with 1.89 years increased epigenetic age diff.**


```{r}
PM_model2 <- lm(grim_agediff ~ PM_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(PM_model2)
confint(PM_model2)
```
**Sig assoc between higher PM2.5 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr PM2.5 assoc with 1.88 years increased epigenetic age diff.**


## SO4 in 5yrs Pre-Sampling
### UPitt Alone
```{r}
SO4_model1 <- lm(grim_agediff ~ SO4_5yrSamp_IQR, data=UPitt_dnam)
summary(SO4_model1)
confint(SO4_model1)
```
*Marginal assoc between higher SO4 exposure in 5yrs pre-sampling and epigenetic age difference.*


```{r}
SO4_model2 <- lm(grim_agediff ~ SO4_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(SO4_model2)
confint(SO4_model2)
```
*Marginal assoc between higher SO4 exposure in 5yrs pre-sampling and epigenetic age difference.*


### UBC Alone
```{r}
SO4_model1 <- lm(grim_agediff ~ SO4_5yrSamp_IQR, data=UBC_dnam)
summary(SO4_model1)
confint(SO4_model1)
```
No significant assoc between higher SO4 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
SO4_model2 <- lm(grim_agediff ~ SO4_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(SO4_model2)
confint(SO4_model2)
```
No significant assoc between higher SO4 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
SO4_model1 <- lm(grim_agediff ~ SO4_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(SO4_model1)
confint(SO4_model1)
```
**Sig assoc between higher SO4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr SO4 assoc with 1.71 years increased epigenetic age diff.**


```{r}
SO4_model2 <- lm(grim_agediff ~ SO4_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(SO4_model2)
confint(SO4_model2)
```
**Sig assoc between higher SO4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr SO4 assoc with 1.66 years increased epigenetic age diff.**



## NO3 in 5yrs Pre-Sampling
### UPitt Alone
```{r}
NO3_model1 <- lm(grim_agediff ~ NO3_5yrSamp_IQR, data=UPitt_dnam)
summary(NO3_model1)
confint(NO3_model1)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NO3 assoc with 1.68 years increased epigenetic age diff.**


```{r}
NO3_model2 <- lm(grim_agediff ~ NO3_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(NO3_model2)
confint(NO3_model2)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NO3 assoc with 1.64 years increased epigenetic age diff.**


### UBC Alone
```{r}
NO3_model1 <- lm(grim_agediff ~ NO3_5yrSamp_IQR, data=UBC_dnam)
summary(NO3_model1)
confint(NO3_model1)
```
No significant assoc between higher NO3 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
NO3_model2 <- lm(grim_agediff ~ NO3_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(NO3_model2)
confint(NO3_model2)
```
No significant assoc between higher NO3 exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
NO3_model1 <- lm(grim_agediff ~ NO3_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(NO3_model1)
confint(NO3_model1)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NO3 assoc with 1.72 years increased epigenetic age diff.**


```{r}
NO3_model2 <- lm(grim_agediff ~ NO3_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(NO3_model2)
confint(NO3_model2)
```
**Significant assoc between higher NO3 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NO3 assoc with 1.67 years increased epigenetic age diff.**


## NH4 in 5yrs Pre-Sampling
### UPitt Alone
```{r}
NH4_model1 <- lm(grim_agediff ~ NH4_5yrSamp_IQR, data=UPitt_dnam)
summary(NH4_model1)
confint(NH4_model1)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NH4 assoc with 2.34 years increased epigenetic age diff.**


```{r}
NH4_model2 <- lm(grim_agediff ~ NH4_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(NH4_model2)
confint(NH4_model2)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NH4 assoc with 2.26 years increased epigenetic age diff.**


### UBC Alone
```{r}
NH4_model1 <- lm(grim_agediff ~ NH4_5yrSamp_IQR, data=UBC_dnam)
summary(NH4_model1)
confint(NH4_model1)
```
*Marginal assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NH4 assoc with 20.40 years increased epigenetic age diff.*


```{r}
NH4_model2 <- lm(grim_agediff ~ NH4_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(NH4_model2)
confint(NH4_model2)
```
*Marginal assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NH4 assoc with 22.27 years increased epigenetic age diff.*

### Combined Cohorts
```{r}
NH4_model1 <- lm(grim_agediff ~ NH4_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(NH4_model1)
confint(NH4_model1)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NH4 assoc with 2.44 years increased epigenetic age diff.**


```{r}
NH4_model2 <- lm(grim_agediff ~ NH4_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(NH4_model2)
confint(NH4_model2)
```
**Significant assoc between higher NH4 exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr NH4 assoc with 2.41 years increased epigenetic age diff.**


## BC in 5yrs Pre-Sampling
### UPitt Alone
```{r}
BC_model1 <- lm(grim_agediff ~ BC_5yrSamp_IQR, data=UPitt_dnam)
summary(BC_model1)
confint(BC_model1)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr BC assoc with 2.44 years increased epigenetic age diff.**


```{r}
BC_model2 <- lm(grim_agediff ~ BC_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(BC_model2)
confint(BC_model2)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr BC assoc with 2.40 years increased epigenetic age diff.**


### UBC Alone
```{r}
BC_model1 <- lm(grim_agediff ~ BC_5yrSamp_IQR, data=UBC_dnam)
summary(BC_model1)
confint(BC_model1)
```
No significant assoc between higher BC exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
BC_model2 <- lm(grim_agediff ~ BC_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(BC_model2)
confint(BC_model2)
```
No significant assoc between higher BC exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
BC_model1 <- lm(grim_agediff ~ BC_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(BC_model1)
confint(BC_model1)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr BC assoc with 1.59 years increased epigenetic age diff.**


```{r}
BC_model2 <- lm(grim_agediff ~ BC_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(BC_model2)
confint(BC_model2)
```
**Significant assoc between higher BC exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr BC assoc with 1.48 years increased epigenetic age diff.**


## OM in 5yrs Pre-Sampling
### UPitt Alone
```{r}
OM_model1 <- lm(grim_agediff ~ OM_5yrSamp_IQR, data=UPitt_dnam)
summary(OM_model1)
confint(OM_model1)
```
**Significant assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr OM assoc with 1.61 years increased epigenetic age diff.**


```{r}
OM_model2 <- lm(grim_agediff ~ OM_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(OM_model2)
confint(OM_model2)
```
**Significant assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr OM assoc with 1.51 years increased epigenetic age diff.**


### UBC Alone
```{r}
OM_model1 <- lm(grim_agediff ~ OM_5yrSamp_IQR, data=UBC_dnam)
summary(OM_model1)
confint(OM_model1)
```
No significant assoc between higher OM exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
OM_model2 <- lm(grim_agediff ~ OM_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(OM_model2)
confint(OM_model2)
```
No significant assoc between higher OM exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
OM_model1 <- lm(grim_agediff ~ OM_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(OM_model1)
confint(OM_model1)
```
**Significant assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr OM assoc with 0.63 years increased epigenetic age diff.**


```{r}
OM_model2 <- lm(grim_agediff ~ OM_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(OM_model2)
confint(OM_model2)
```
**Sig assoc between higher OM exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr OM assoc with 0.55 years increased epigenetic age diff.**


## SS in 5yrs Pre-Sampling
### UPitt Alone
```{r}
SS_model1 <- lm(grim_agediff ~ SS_5yrSamp_IQR, data=UPitt_dnam)
summary(SS_model1)
confint(SS_model1)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and epigenetic age difference.


```{r}
SS_model2 <- lm(grim_agediff ~ SS_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(SS_model2)
confint(SS_model2)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and epigenetic age difference.


### UBC Alone
```{r}
SS_model1 <- lm(grim_agediff ~ SS_5yrSamp_IQR, data=UBC_dnam)
summary(SS_model1)
confint(SS_model1)
```
*Marginal assoc between higher SS exposure in 5yrs pre-sampling and lower epigenetic age difference in UBC-PF cohort.*


```{r}
SS_model2 <- lm(grim_agediff ~ SS_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(SS_model2)
confint(SS_model2)
```
*Marginal assoc between higher SS exposure in 5yrs pre-sampling and lower epigenetic age difference in UBC cohort (i.e. trending towards biologically younger).*

### Combined Cohorts
```{r}
SS_model1 <- lm(grim_agediff ~ SS_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(SS_model1)
confint(SS_model1)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and  epigenetic age difference.


```{r}
SS_model2 <- lm(grim_agediff ~ SS_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(SS_model2)
confint(SS_model2)
```
No significant assoc between higher SS exposure in 5yrs pre-sampling and  epigenetic age difference.


## Soil in 5yrs Pre-Sampling
### UPitt Alone
```{r}
Soil_model1 <- lm(grim_agediff ~ Soil_5yrSamp_IQR, data=UPitt_dnam)
summary(Soil_model1)
confint(Soil_model1)
```
*Marginal assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr Soil assoc with 1.28 years increased epigenetic age diff.*


```{r}
Soil_model2 <- lm(grim_agediff ~ Soil_5yrSamp_IQR + dich_Race + disadv, data=UPitt_dnam)
summary(Soil_model2)
confint(Soil_model2)
```
*Marginal assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr Soil assoc with 1.26 years increased epigenetic age diff.*


### UBC Alone
```{r}
Soil_model1 <- lm(grim_agediff ~ Soil_5yrSamp_IQR, data=UBC_dnam)
summary(Soil_model1)
confint(Soil_model1)
```
No significant assoc between higher Soil exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.


```{r}
Soil_model2 <- lm(grim_agediff ~ Soil_5yrSamp_IQR + dich_Race + disadv, data=UBC_dnam)
summary(Soil_model2)
confint(Soil_model2)
```
No significant assoc between higher Soil exposure in 5yrs pre-sampling and epigenetic age difference in UBC-PF cohort.

### Combined Cohorts
```{r}
Soil_model1 <- lm(grim_agediff ~ Soil_5yrSamp_IQR + cluster(cohort), data=dnam)
summary(Soil_model1)
confint(Soil_model1)
```
**Significant assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr Soil assoc with 1.41 years increased epigenetic age diff.**


```{r}
Soil_model2 <- lm(grim_agediff ~ Soil_5yrSamp_IQR + dich_Race + disadv + cluster(cohort), data=dnam)
summary(Soil_model2)
confint(Soil_model2)
```
**Significant assoc between higher Soil exposure in 5yrs pre-sampling and higher epigenetic age difference. I.e. each 1 IQR increase 5yr Soil assoc with 1.38 years increased epigenetic age diff.**


## Forest Plots for Pollutant Assoc with EAD
### PM2.5, SO4, NO3, and NH4
```{r}
EAD <- structure(list(mean=c(NA, 1.88, 1.66, 1.67, 2.41, 1.48, 0.55, -0.25, 1.38),
                      lower=c(NA, 0.47, 0.002, 0.57, 0.71, 0.43, 0.03, -0.82, 0.23),
                      upper=c(NA, 3.29, 3.31, 2.76, 4.10, 2.53, 1.07, 0.31, 2.53)),
                 .Names=c("mean","lower","upper"),
                 row.names=c(NA, -11L),
                 class="data.frame")

tabletext <- cbind(c("  Pollutant", "PM2.5", "SO4", "NO3", "NH4", "BC", "OM", "SS", "Soil"),
                   c("Beta (95% CI)", "1.88 (0.47 to 3.29)", "1.66 (0.002 to 3.31)", "1.67 (0.57 to 2.76)", "2.41 (0.71 to 4.10)", "1.48 (0.42 to 2.53)", "0.55 (0.03 to 1.07)", "-0.25 (-0.82 to 0.31)", "1.38 (0.23 to 2.53)"),
                   c("P-value", "0.009", "0.049", "0.003", "0.005", "0.006", "0.04", "0.38", "0.02"))


EAD %>% forestplot(labeltext = tabletext, 
             is.summary = c(TRUE, rep(FALSE, 8)),
             clip = c(-4, 15), 
             col = fpColors(box = "royalblue",
                            line = "darkblue",
                           summary = "royalblue"),
             boxsize = 0.3,
             vp.width = 0.5, # Adjust the width to tilt the boxes
             vp.height = 0.5)
```

## Multiconstituent Models for assoc of PM2.5 constituents with EAD
### UPitt
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4_5yrPreSamp','NO3_5yrPreSamp','NH4_5yrPreSamp','BC_5yrPreSamp','OM_5yrPreSamp','SS_5yrPreSamp','Soil_5yrPreSamp')

lm(grim_agediff ~ SO4_5yrPreSamp + NH4_5yrPreSamp + NO3_5yrPreSamp + BC_5yrPreSamp + OM_5yrPreSamp + SS_5yrPreSamp + Soil_5yrPreSamp, data=UPitt_dnam)

#Next construct the base linear model
qc.fit1 <- qgcomp.noboot(grim_agediff~.,data=UPitt_dnam[,c(Xnm, 'grim_agediff')], expnms=Xnm, family=gaussian(), q=4)

#view the results
qc.fit1
```
**Increased PM2.5 mixture significantly assoc with increased epigenetic age difference. I.e. each 1 quartile increase PM2.5 mixture assoc with 0.87 year increased EAD with NH4 > BC > Soil > SS having the most harmful effects.**

Complete multi-pollutant model
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4_5yrPreSamp','NO3_5yrPreSamp','NH4_5yrPreSamp','BC_5yrPreSamp','OM_5yrPreSamp','SS_5yrPreSamp','Soil_5yrPreSamp')

lm(grim_agediff ~ SO4_5yrPreSamp + NH4_5yrPreSamp + NO3_5yrPreSamp + BC_5yrPreSamp + OM_5yrPreSamp + SS_5yrPreSamp + Soil_5yrPreSamp  + dich_Race + disadv, data=UPitt_dnam)


qc.fit2 <- qgcomp.noboot(grim_agediff~.,data=UPitt_dnam[,c(Xnm, 'dich_Race',  'disadv', 'grim_agediff')], expnms=Xnm, family=gaussian(), q=4)

qc.fit2
```
**Increased PM2.5 mixture significantly assoc with increased epigenetic age difference. I.e. each 1 quartile increase PM2.5 mixture assoc with 0.94 year increased EAD with NH4 > BC > Soil > SS having the most harmful effects.**


### UBC
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4_5yrPreSamp','NO3_5yrPreSamp','NH4_5yrPreSamp','BC_5yrPreSamp','OM_5yrPreSamp','SS_5yrPreSamp','Soil_5yrPreSamp')

lm(grim_agediff ~ SO4_5yrPreSamp + NH4_5yrPreSamp + NO3_5yrPreSamp + BC_5yrPreSamp + OM_5yrPreSamp + SS_5yrPreSamp + Soil_5yrPreSamp, data=UBC_dnam)

#Next construct the base linear model
qc.fit1 <- qgcomp.noboot(grim_agediff~.,data=UBC_dnam[,c(Xnm, 'grim_agediff')], expnms=Xnm, family=gaussian(), q=4)

#view the results
qc.fit1
```
No sig assoc between PM2.5 mixture significantly assoc and epigenetic age difference in UBC cohort.

Complete multi-pollutant model
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4_5yrPreSamp','NO3_5yrPreSamp','NH4_5yrPreSamp','BC_5yrPreSamp','OM_5yrPreSamp','SS_5yrPreSamp','Soil_5yrPreSamp')

lm(grim_agediff ~ SO4_5yrPreSamp + NH4_5yrPreSamp + NO3_5yrPreSamp + BC_5yrPreSamp + OM_5yrPreSamp + SS_5yrPreSamp + Soil_5yrPreSamp + dich_Race + disadv, data=UBC_dnam)


qc.fit2 <- qgcomp.noboot(grim_agediff~.,data=UBC_dnam[,c(Xnm, 'dich_Race',  'disadv', 'grim_agediff')], expnms=Xnm, family=gaussian(), q=4)

qc.fit2
```
No sig assoc between PM2.5 mixture significantly assoc and epigenetic age difference in UBC cohort.

### Combined Cohorts
Unadjusted model
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4_5yrPreSamp','NO3_5yrPreSamp','NH4_5yrPreSamp','BC_5yrPreSamp','OM_5yrPreSamp','SS_5yrPreSamp','Soil_5yrPreSamp')

lm(grim_agediff ~ SO4_5yrPreSamp + NH4_5yrPreSamp + NO3_5yrPreSamp + BC_5yrPreSamp + OM_5yrPreSamp + SS_5yrPreSamp + Soil_5yrPreSamp + cluster(cohort), data=dnam)

#Next construct the base linear model
qc.fit1 <- qgcomp.noboot(grim_agediff~.,data=dnam[,c(Xnm, 'cohort', 'grim_agediff')], expnms=Xnm, family=gaussian(), q=4)

#view the results
qc.fit1
```
**Increased PM2.5 mixture significantly assoc with increased epigenetic age difference. I.e. each 1 quartile increase PM2.5 mixture assoc with 1.07 year increased EAD with NH4 > Soil > OM > NO3 having the most harmful effects.**

Coviariate Adjusted multi-pollutant model
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4_5yrPreSamp','NO3_5yrPreSamp','NH4_5yrPreSamp','BC_5yrPreSamp','OM_5yrPreSamp','SS_5yrPreSamp','Soil_5yrPreSamp')

lm(grim_agediff ~ SO4_5yrPreSamp + NH4_5yrPreSamp + NO3_5yrPreSamp + BC_5yrPreSamp + OM_5yrPreSamp + SS_5yrPreSamp + Soil_5yrPreSamp + dich_Race + disadv + cluster(cohort), data=dnam)


qc.fit2 <- qgcomp.noboot(grim_agediff~.,data=dnam[,c(Xnm, 'dich_Race',  'disadv', 'cohort', 'grim_agediff')], expnms=Xnm, family=gaussian(), q=4)

qc.fit2
```
**Increased PM2.5 mixture significantly assoc with increased epigenetic age difference. I.e. each 1 quartile increase PM2.5 mixture assoc with 1.12 year increased EAD with NH4 > Soil OM > BC > NO3 having the most harmful effects.**


# Disadvantage Association with Epigenetic Age Difference
## UPitt Alone - ADI score association
```{r}
disadv_model1 <- lm(grim_agediff ~ disadv, data=UPitt_dnam)
summary(disadv_model1)
confint(disadv_model1)
```
*Marginal assoc between higher disadvantage score and higher epigenetic age difference. I.e. each 10 percentile increase in ADI assoc with 1.69 years increased epigenetic age diff.*


```{r}
disadv_model2 <- lm(grim_agediff ~ disadv + dich_Race, data=UPitt_dnam)
summary(disadv_model2)
confint(disadv_model2)
```
No assoc between higher disadvantage score and higher epigenetic age difference.


### UBC Alone
```{r}
disadv_model1 <- lm(grim_agediff ~ disadv, data=UBC_dnam)
summary(disadv_model1)
confint(disadv_model1)
```
No significant assoc between higher CIMD and epigenetic age difference in UBC-PF cohort.


```{r}
disadv_model2 <- lm(grim_agediff ~ disadv + dich_Race, data=UBC_dnam)
summary(disadv_model2)
confint(disadv_model2)
```


### Combined Cohorts
```{r}
disadv_model1 <- lm(grim_agediff ~ disadv + cluster(cohort), data=dnam)
summary(disadv_model1)
confint(disadv_model1)
```
No significant assoc between higher disadvantage score and epigenetic age difference in combined cohorts.


```{r}
disadv_model2 <- lm(grim_agediff ~ disadv + dich_Race + cluster(cohort), data=dnam)
summary(disadv_model2)
confint(disadv_model2)
```
No sig assoc between higher disadvantage score and epigenetic age difference in the combined cohorts.


# Pollutant Associations with Mortality & Mediation by grim_agediff
## PM2.5 in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the PM_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["PM_5yrPreSamp"])/(coxPH_model1a$coefficients["PM_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the PM_5yrPreSamp HR, suggesting that a portion of the effect of PM2.5 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["PM_5yrPreSamp"])/(coxPH_model2a$coefficients["PM_5yrPreSamp"])))
med_prop
```
This indicates that ~9% of the association of PM2.5 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - PM2.5 UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ PM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="PM_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~12% of the PM2.5 assoc with mortality is mediated through grim_agediff.**

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
PM2.5 in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["PM_5yrPreSamp"])/(coxPH_model1a$coefficients["PM_5yrPreSamp"])))
med_prop
```


Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
PM2.5 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the PM_5yrPreSamp HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["PM_5yrPreSamp"])/(coxPH_model2a$coefficients["PM_5yrPreSamp"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.

### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the PM_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["PM_5yrPreSamp"])/(coxPH_model1a$coefficients["PM_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the PM_5yrPreSamp HR, suggesting that aa portion of the effect of PM2.5 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["PM_5yrPreSamp"])/(coxPH_model2a$coefficients["PM_5yrPreSamp"])))
med_prop
```
This indicates that ~24% of the association of PM2.5 with mortality may be mediated by grim_agediff in these adjusted models.

### Causal Mediation Analysis - PM2.5 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ PM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="PM_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~15% of the PM2.5 assoc with mortality is mediated through grim_agediff, and this effect is significant.**



## SO4 in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the SO4_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SO4_5yrPreSamp"])/(coxPH_model1a$coefficients["SO4_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the SO4_5yrPreSamp HR, suggesting that a portion of the effect of SO4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SO4_5yrPreSamp"])/(coxPH_model2a$coefficients["SO4_5yrPreSamp"])))
med_prop
```
This indicates that ~6% of the association of SO4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - SO4 UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ SO4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SO4_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
This indicates that ~7% of the SO4 assoc with mortality is mediated through grim_agediff, but this effect is not significant.

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
SO4 in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the SO4_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SO4_5yrPreSamp"])/(coxPH_model1a$coefficients["SO4_5yrPreSamp"])))
med_prop
```

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
SO4 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SO4_5yrPreSamp"])/(coxPH_model2a$coefficients["SO4_5yrPreSamp"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.


### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the SO4_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SO4_5yrPreSamp"])/(coxPH_model1a$coefficients["SO4_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the SO4_5yrPreSamp HR, suggesting that aa portion of the effect of SO4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SO4_5yrPreSamp"])/(coxPH_model2a$coefficients["SO4_5yrPreSamp"])))
med_prop
```
This indicates that ~21% of the association of SO4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - SO4 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ SO4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SO4_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
This indicates that 11% of the SO4 assoc with mortality is mediated through grim_agediff, but this effect is not significant.





## NO3 in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NO3_5yrPreSamp"])/(coxPH_model1a$coefficients["NO3_5yrPreSamp"])))
med_prop
```
Can't rely on mediation proportion as neither preceding analyses significant.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the NO3_5yrPreSamp HR, but still not significant

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NO3_5yrPreSamp"])/(coxPH_model2a$coefficients["NO3_5yrPreSamp"])))
med_prop
```
Can't rely on this number as not significant analyses

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
NO3 in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the NO3_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NO3_5yrPreSamp"])/(coxPH_model1a$coefficients["NO3_5yrPreSamp"])))
med_prop
```
Can't rely on this mediation proportion as neither preceding analysis significant.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the NO3_5yrPreSamp HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NO3_5yrPreSamp"])/(coxPH_model2a$coefficients["NO3_5yrPreSamp"])))
med_prop
```
Can't rely on this mediation proportion as neither preceding analysis significant.


### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**NO3 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually doesnt change the NO3_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NO3_5yrPreSamp"])/(coxPH_model1a$coefficients["NO3_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**NO3 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the NO3_5yrPreSamp HR, suggesting that aa portion of the effect of NO3 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NO3_5yrPreSamp"])/(coxPH_model2a$coefficients["NO3_5yrPreSamp"])))
med_prop
```
This indicates that ~33% of the association of NO3 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - NO3 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ NO3_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="NO3_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~23% of the NO3 assoc with mortality is mediated through grim_agediff, and this effect is marginal.*






## NH4 in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the NH4_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NH4_5yrPreSamp"])/(coxPH_model1a$coefficients["NH4_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the NH4_5yrPreSamp HR, suggesting that aa portion of the effect of NH4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NH4_5yrPreSamp"])/(coxPH_model2a$coefficients["NH4_5yrPreSamp"])))
med_prop
```
This indicates that ~5% of the association of NH4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - NH4 UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ NH4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="NH4_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~10% of the NH4 assoc with mortality is mediated through grim_agediff, and this effect is marginal.*

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
**NH4 in 5yrs pre-sampling associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the NH4_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NH4_5yrPreSamp"])/(coxPH_model1a$coefficients["NH4_5yrPreSamp"])))
med_prop
```
6% mediation in unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
NH4 in 5yrs pre-sampling not associated with increased mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NH4_5yrPreSamp"])/(coxPH_model2a$coefficients["NH4_5yrPreSamp"])))
med_prop
```
Mediation proportion ~28%



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the NH4_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NH4_5yrPreSamp"])/(coxPH_model1a$coefficients["NH4_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the NH4_5yrPreSamp HR, suggesting that aa portion of the effect of NH4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NH4_5yrPreSamp"])/(coxPH_model2a$coefficients["NH4_5yrPreSamp"])))
med_prop
```
This indicates that ~23% of the association of NH4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - NH4 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ NH4_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="NH4_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~14% of the NH4 assoc with mortality is mediated through grim_agediff, and this effect is marginal.*






## BC in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["BC_5yrPreSamp"])/(coxPH_model1a$coefficients["BC_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["BC_5yrPreSamp"])/(coxPH_model2a$coefficients["BC_5yrPreSamp"])))
med_prop
```
Neither preceding analysis significant, so can't rely on this proportion

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["BC_5yrPreSamp"])/(coxPH_model1a$coefficients["BC_5yrPreSamp"])))
med_prop
```
Neither preceding analysis significant so can't rely on this proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
BC in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["BC_5yrPreSamp"])/(coxPH_model2a$coefficients["BC_5yrPreSamp"])))
med_prop
```
Neither analyses are significant in the UBC models, so can't rely much on this mediation proportion.



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**BC in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually does not largely change the BC_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["BC_5yrPreSamp"])/(coxPH_model1a$coefficients["BC_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**BC in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the BC_5yrPreSamp HR, suggesting that aa portion of the effect of BC in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["BC_5yrPreSamp"])/(coxPH_model2a$coefficients["BC_5yrPreSamp"])))
med_prop
```
This indicates that ~47% of the association of BC with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - BC Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ BC_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="BC_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~29% of the BC assoc with mortality is mediated through grim_agediff, and this effect is marginal.*





## OM in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["OM_5yrPreSamp"])/(coxPH_model1a$coefficients["OM_5yrPreSamp"])))
med_prop
```
Neither preceding model significant so can't rely on this proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["OM_5yrPreSamp"])/(coxPH_model2a$coefficients["OM_5yrPreSamp"])))
med_prop
```
Neither preceding analysis significant so can't rely on this proportion

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the OM_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["OM_5yrPreSamp"])/(coxPH_model1a$coefficients["OM_5yrPreSamp"])))
med_prop
```
Neither preceding analysis significant so can't rely on mediation proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
OM in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["OM_5yrPreSamp"])/(coxPH_model2a$coefficients["OM_5yrPreSamp"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.


### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**OM in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the OM_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["OM_5yrPreSamp"])/(coxPH_model1a$coefficients["OM_5yrPreSamp"])))
med_prop
```
This indicates that there is 4% mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**OM in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the OM_5yrPreSamp HR, suggesting that aa portion of the effect of OM in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["OM_5yrPreSamp"])/(coxPH_model2a$coefficients["OM_5yrPreSamp"])))
med_prop
```
This indicates that ~52% of the association of OM with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - OM Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ OM_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="OM_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
This indicates that ~30% of the OM assoc with mortality is mediated through grim_agediff, but this effect is not significant






## SS in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**SS in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the SS_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SS_5yrPreSamp"])/(coxPH_model1a$coefficients["SS_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
*SS in 5yrs pre-sampling is marginally associated with increased mortality in this model.*

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the SS_5yrPreSamp HR, suggesting that a portion of the effect of SS in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SS_5yrPreSamp"])/(coxPH_model2a$coefficients["SS_5yrPreSamp"])))
med_prop
```
This indicates that ~7% of the association of SS with mortality may be mediated by beta value at grim_agediff in these adjusted models.



### Causal Mediation Analysis - SS UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ SS_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SS_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
11% mediation but not significant.


### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
SS in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the SS_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SS_5yrPreSamp"])/(coxPH_model1a$coefficients["SS_5yrPreSamp"])))
med_prop
```
Neither analysis significant so can't rely on the mediation proportion in this analysis.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
SS in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the SS_5yrPreSamp HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SS_5yrPreSamp"])/(coxPH_model2a$coefficients["SS_5yrPreSamp"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
SS in 5yrs pre-sampling is not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the SS_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SS_5yrPreSamp"])/(coxPH_model1a$coefficients["SS_5yrPreSamp"])))
med_prop
```
Can't interpret as neither previous models significant.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
SS in 5yrs pre-sampling is not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SS_5yrPreSamp"])/(coxPH_model2a$coefficients["SS_5yrPreSamp"])))
med_prop
```
Not interpretable
 
### Causal Mediation Analysis - SS Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ SS_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SS_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
Not interpretable




## Soil in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["Soil_5yrPreSamp"])/(coxPH_model1a$coefficients["Soil_5yrPreSamp"])))
med_prop
```
Neither preceding model significant so can't rely on this mediation proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["Soil_5yrPreSamp"])/(coxPH_model2a$coefficients["Soil_5yrPreSamp"])))
med_prop
```
Not interpretable

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
Soil in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the Soil_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["Soil_5yrPreSamp"])/(coxPH_model1a$coefficients["Soil_5yrPreSamp"])))
med_prop
```
Neither preceding analysis significant, so can't rely on this mediation proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the Soil_5yrPreSamp HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["Soil_5yrPreSamp"])/(coxPH_model2a$coefficients["Soil_5yrPreSamp"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**Soil in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the Soil_5yrPreSamp HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["Soil_5yrPreSamp"])/(coxPH_model1a$coefficients["Soil_5yrPreSamp"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**Soil in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the Soil_5yrPreSamp HR, suggesting that aa portion of the effect of Soil on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["Soil_5yrPreSamp"])/(coxPH_model2a$coefficients["Soil_5yrPreSamp"])))
med_prop
```
This indicates that ~32% of the association of Soil with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - Soil Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ Soil_5yrPreSamp + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrPreSamp + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="Soil_5yrPreSamp", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~23% of the Soil assoc with mortality is mediated through grim_agediff, and this effect is significant.**


# IQR Pollutant Associations with Mortality & Mediation by grim_agediff
## PM2.5 IQR in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the PM_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["PM_5yrSamp_IQR"])/(coxPH_model1a$coefficients["PM_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the PM_5yrSamp_IQR HR, suggesting that a portion of the effect of PM2.5 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["PM_5yrSamp_IQR"])/(coxPH_model2a$coefficients["PM_5yrSamp_IQR"])))
med_prop
```
This indicates that ~9% of the association of PM2.5 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - PM2.5 UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ PM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="PM_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~12% of the PM2.5 assoc with mortality is mediated through grim_agediff, and this effect is significant.**

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
PM2.5 in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["PM_5yrSamp_IQR"])/(coxPH_model1a$coefficients["PM_5yrSamp_IQR"])))
med_prop
```


Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
PM2.5 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the PM_5yrSamp_IQR HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["PM_5yrSamp_IQR"])/(coxPH_model2a$coefficients["PM_5yrSamp_IQR"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.

### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the PM_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["PM_5yrSamp_IQR"])/(coxPH_model1a$coefficients["PM_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**PM2.5 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the PM_5yrSamp_IQR HR, suggesting that aa portion of the effect of PM2.5 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["PM_5yrSamp_IQR"])/(coxPH_model2a$coefficients["PM_5yrSamp_IQR"])))
med_prop
```
This indicates that ~24% of the association of PM2.5 with mortality may be mediated by grim_agediff in these adjusted models.

### Causal Mediation Analysis - PM2.5 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ PM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ PM_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="PM_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~16% of the PM2.5 assoc with mortality is mediated through grim_agediff, and this effect is significant.**



## SO4 in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the SO4_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SO4_5yrSamp_IQR"])/(coxPH_model1a$coefficients["SO4_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the SO4_5yrSamp_IQR HR, suggesting that a portion of the effect of SO4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SO4_5yrSamp_IQR"])/(coxPH_model2a$coefficients["SO4_5yrSamp_IQR"])))
med_prop
```
This indicates that ~6% of the association of SO4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - SO4 UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ SO4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SO4_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
This indicates that ~7% of the SO4 assoc with mortality is mediated through grim_agediff, but this effect is not significant.

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
SO4 in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the SO4_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SO4_5yrSamp_IQR"])/(coxPH_model1a$coefficients["SO4_5yrSamp_IQR"])))
med_prop
```

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
SO4 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SO4_5yrSamp_IQR"])/(coxPH_model2a$coefficients["SO4_5yrSamp_IQR"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.


### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the SO4_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SO4_5yrSamp_IQR"])/(coxPH_model1a$coefficients["SO4_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**SO4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the SO4_5yrSamp_IQR HR, suggesting that aa portion of the effect of SO4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SO4_5yrSamp_IQR"])/(coxPH_model2a$coefficients["SO4_5yrSamp_IQR"])))
med_prop
```
This indicates that ~21% of the association of SO4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - SO4 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ SO4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SO4_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SO4_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
This indicates that 11% of the SO4 assoc with mortality is mediated through grim_agediff, but this effect is not significant.





## NO3 in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NO3_5yrSamp_IQR"])/(coxPH_model1a$coefficients["NO3_5yrSamp_IQR"])))
med_prop
```
Can't rely on mediation proportion as neither preceding analyses significant.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the NO3_5yrSamp_IQR HR, but still not significant

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NO3_5yrSamp_IQR"])/(coxPH_model2a$coefficients["NO3_5yrSamp_IQR"])))
med_prop
```
Can't rely on this number as not significant analyses

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
NO3 in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the NO3_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NO3_5yrSamp_IQR"])/(coxPH_model1a$coefficients["NO3_5yrSamp_IQR"])))
med_prop
```
Can't rely on this mediation proportion as neither preceding analysis significant.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
NO3 in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the NO3_5yrSamp_IQR HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NO3_5yrSamp_IQR"])/(coxPH_model2a$coefficients["NO3_5yrSamp_IQR"])))
med_prop
```
Can't rely on this mediation proportion as neither preceding analysis significant.


### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**NO3 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually doesnt change the NO3_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NO3_5yrSamp_IQR"])/(coxPH_model1a$coefficients["NO3_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**NO3 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the NO3_5yrSamp_IQR HR, suggesting that aa portion of the effect of NO3 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NO3_5yrSamp_IQR"])/(coxPH_model2a$coefficients["NO3_5yrSamp_IQR"])))
med_prop
```
This indicates that ~33% of the association of NO3 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - NO3 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ NO3_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ NO3_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="NO3_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~23% of the NO3 assoc with mortality is mediated through grim_agediff, and this effect is marginal.*






## NH4 in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the NH4_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NH4_5yrSamp_IQR"])/(coxPH_model1a$coefficients["NH4_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the NH4_5yrSamp_IQR HR, suggesting that aa portion of the effect of NH4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NH4_5yrSamp_IQR"])/(coxPH_model2a$coefficients["NH4_5yrSamp_IQR"])))
med_prop
```
This indicates that ~5% of the association of NH4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - NH4 UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ NH4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="NH4_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~10% of the NH4 assoc with mortality is mediated through grim_agediff, and the effect is marginal.*

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
**NH4 in 5yrs pre-sampling associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the NH4_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NH4_5yrSamp_IQR"])/(coxPH_model1a$coefficients["NH4_5yrSamp_IQR"])))
med_prop
```
6% mediation in unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
NH4 in 5yrs pre-sampling not associated with increased mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NH4_5yrSamp_IQR"])/(coxPH_model2a$coefficients["NH4_5yrSamp_IQR"])))
med_prop
```



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the NH4_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["NH4_5yrSamp_IQR"])/(coxPH_model1a$coefficients["NH4_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**NH4 in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the NH4_5yrSamp_IQR HR, suggesting that aa portion of the effect of NH4 in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["NH4_5yrSamp_IQR"])/(coxPH_model2a$coefficients["NH4_5yrSamp_IQR"])))
med_prop
```
This indicates that ~23% of the association of NH4 with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - NH4 Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ NH4_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ NH4_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="NH4_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~14% of the NH4 assoc with mortality is mediated through grim_agediff, and this effect is marginal.*






## BC in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["BC_5yrSamp_IQR"])/(coxPH_model1a$coefficients["BC_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["BC_5yrSamp_IQR"])/(coxPH_model2a$coefficients["BC_5yrSamp_IQR"])))
med_prop
```
Neither preceding analysis significant, so can't rely on this proportion

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["BC_5yrSamp_IQR"])/(coxPH_model1a$coefficients["BC_5yrSamp_IQR"])))
med_prop
```
Neither preceding analysis significant so can't rely on this proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
BC in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
BC in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["BC_5yrSamp_IQR"])/(coxPH_model2a$coefficients["BC_5yrSamp_IQR"])))
med_prop
```
Neither analyses are significant in the UBC models, so can't rely much on this mediation proportion.



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**BC in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually does not largely change the BC_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["BC_5yrSamp_IQR"])/(coxPH_model1a$coefficients["BC_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**BC in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the BC_5yrSamp_IQR HR, suggesting that aa portion of the effect of BC in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["BC_5yrSamp_IQR"])/(coxPH_model2a$coefficients["BC_5yrSamp_IQR"])))
med_prop
```
This indicates that ~47% of the association of BC with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - BC Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ BC_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ BC_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="BC_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
*This indicates that ~28% of the BC assoc with mortality is mediated through grim_agediff, and this effect is marginal.*





## OM in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["OM_5yrSamp_IQR"])/(coxPH_model1a$coefficients["OM_5yrSamp_IQR"])))
med_prop
```
Neither preceding model significant so can't rely on this proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["OM_5yrSamp_IQR"])/(coxPH_model2a$coefficients["OM_5yrSamp_IQR"])))
med_prop
```
Neither preceding analysis significant so can't rely on this proportion

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the OM_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["OM_5yrSamp_IQR"])/(coxPH_model1a$coefficients["OM_5yrSamp_IQR"])))
med_prop
```
Neither preceding analysis significant so can't rely on mediation proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
OM in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
OM in 5yrs pre-sampling not associated with increased mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["OM_5yrSamp_IQR"])/(coxPH_model2a$coefficients["OM_5yrSamp_IQR"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.


### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**OM in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the OM_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["OM_5yrSamp_IQR"])/(coxPH_model1a$coefficients["OM_5yrSamp_IQR"])))
med_prop
```
This indicates that there is 4% mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**OM in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the OM_5yrSamp_IQR HR, suggesting that aa portion of the effect of OM in 5yrs pre-sampling on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["OM_5yrSamp_IQR"])/(coxPH_model2a$coefficients["OM_5yrSamp_IQR"])))
med_prop
```
This indicates that ~52% of the association of OM with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - OM Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ OM_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="OM_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
This indicates that ~30% of the OM assoc with mortality is mediated through grim_agediff, and this effect is not significant.






## SS in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
**SS in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the SS_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SS_5yrSamp_IQR"])/(coxPH_model1a$coefficients["SS_5yrSamp_IQR"])))
med_prop
```
This indicates that there is a 1% mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
*SS in 5yrs pre-sampling is marginally associated with increased mortality in this model.*

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SS_5yrSamp_IQR"])/(coxPH_model2a$coefficients["SS_5yrSamp_IQR"])))
med_prop
```
This indicates that ~7% of the association of SS with mortality may be mediated by beta value at grim_agediff in these adjusted models.



### Causal Mediation Analysis - SS UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ SS_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SS_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
11% mediation but not significant.


### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
SS in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the SS_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SS_5yrSamp_IQR"])/(coxPH_model1a$coefficients["SS_5yrSamp_IQR"])))
med_prop
```
Neither analysis significant so can't rely on the mediation proportion in this analysis.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
SS in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the SS_5yrSamp_IQR HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SS_5yrSamp_IQR"])/(coxPH_model2a$coefficients["SS_5yrSamp_IQR"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
SS in 5yrs pre-sampling is not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the SS_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["SS_5yrSamp_IQR"])/(coxPH_model1a$coefficients["SS_5yrSamp_IQR"])))
med_prop
```
Can't interpret as neither previous models significant.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
SS in 5yrs pre-sampling is not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["SS_5yrSamp_IQR"])/(coxPH_model2a$coefficients["SS_5yrSamp_IQR"])))
med_prop
```
Not interpretable
 
### Causal Mediation Analysis - SS Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ SS_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ SS_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="SS_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
Not interpretable




## Soil in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["Soil_5yrSamp_IQR"])/(coxPH_model1a$coefficients["Soil_5yrSamp_IQR"])))
med_prop
```
Neither preceding model significant so can't rely on this mediation proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["Soil_5yrSamp_IQR"])/(coxPH_model2a$coefficients["Soil_5yrSamp_IQR"])))
med_prop
```
Not interpretable

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
Soil in 5yrs pre-sampling not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff decreases the Soil_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["Soil_5yrSamp_IQR"])/(coxPH_model1a$coefficients["Soil_5yrSamp_IQR"])))
med_prop
```
Neither preceding analysis significant, so can't rely on this mediation proportion.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
Soil in 5yrs pre-sampling not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + sex + dich_Race + disadv + age_dx + dx_IPF + smokeHx+ grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the Soil_5yrSamp_IQR HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["Soil_5yrSamp_IQR"])/(coxPH_model2a$coefficients["Soil_5yrSamp_IQR"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.



### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
**Soil in 5yrs pre-sampling is associated with increased mortality in this model.**

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the Soil_5yrSamp_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["Soil_5yrSamp_IQR"])/(coxPH_model1a$coefficients["Soil_5yrSamp_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**Soil in 5yrs pre-sampling is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the Soil_5yrSamp_IQR HR, suggesting that aa portion of the effect of Soil on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["Soil_5yrSamp_IQR"])/(coxPH_model2a$coefficients["Soil_5yrSamp_IQR"])))
med_prop
```
This indicates that ~32% of the association of Soil with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - Soil Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ Soil_5yrSamp_IQR + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ Soil_5yrSamp_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + disadv + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="Soil_5yrSamp_IQR", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~22% of the Soil assoc with mortality is mediated through grim_agediff, and this effect is significant.**

# Disadvantage Associations with Mortality & Mediation by grim_agediff
## Disadvantage in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
Disadvantage is not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the disadv HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["disadv"])/(coxPH_model1a$coefficients["disadv"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + sex + age_dx + smokeHx + dich_Race + dx_IPF, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
Disadvantage is not associated with increased mortality in this model (although it nears significance with previously reported HR similar to our prior reports in larger cohorts).

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + sex + age_dx + smokeHx + dich_Race + dx_IPF + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the disadv HR, suggesting that a portion of the effect of Disadvantage on mortality is mediated through methylation at grim_agediff.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["disadv"])/(coxPH_model2a$coefficients["disadv"])))
med_prop
```
This indicates that ~10% of the association of Disadvantage with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - Disadvantage UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ disadv + sex + age_dx + smokeHx + dich_Race + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + grim_agediff + sex + age_dx + smokeHx + dich_Race + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="disadv", mediator="grim_agediff")
summary(med1)
```
This indicates that ~13% of the Disadvantage assoc with mortality is mediated through grim_agediff, but this effect is not significant.

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
Disadvantage not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["disadv"])/(coxPH_model1a$coefficients["disadv"])))
med_prop
```


Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + sex + dich_Race + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
Disadvantage not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + sex + dich_Race + age_dx + dx_IPF + smokeHx + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model increases the disadv HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["disadv"])/(coxPH_model2a$coefficients["disadv"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.

### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
Disadvantage is not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["disadv"])/(coxPH_model1a$coefficients["disadv"])))
med_prop
```
Uninterpretable

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**Disadvantage is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the disadv HR, suggesting that aa portion of the effect of Disadvantage on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["disadv"])/(coxPH_model2a$coefficients["disadv"])))
med_prop
```
This indicates that ~21% of the association of Disadvantage with mortality may be mediated by grim_agediff in these adjusted models.

### Causal Mediation Analysis - Disadvantage Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ disadv + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv + grim_agediff + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="disadv", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~27% of the Disadvantage assoc with mortality is mediated through grim_agediff, and this effect is significant.**


# Disadvantage IQR Associations with Mortality & Mediation by grim_agediff
## Disadvantage IQR in 5yrs Pre-Sampling
### UPitt
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR, data=UPitt_dnam, id=ID)
summary(coxPH_model1a)
```
Disadvantage is not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model1b)
```
Including grim_agediff actually increases the disadv_IQR HR

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["disadv_IQR"])/(coxPH_model1a$coefficients["disadv_IQR"])))
med_prop
```
This indicates that there is no mediation in the unadjusted model.

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + sex + age_dx + smokeHx + dich_Race + dx_IPF, data=UPitt_dnam, id=ID)
summary(coxPH_model2a)
```
Disadvantage is not associated with increased mortality in this model (although it nears significance with previously reported HR similar to our prior reports in larger cohorts).

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + sex + age_dx + smokeHx + dich_Race + dx_IPF + grim_agediff, data=UPitt_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model decreases the disadv_IQR HR, suggesting that a portion of the effect of Disadvantage on mortality is mediated through methylation at grim_agediff.

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["disadv_IQR"])/(coxPH_model2a$coefficients["disadv_IQR"])))
med_prop
```
This indicates that ~10% of the association of Disadvantage with mortality may be mediated by beta value at grim_agediff in these adjusted models.

### Causal Mediation Analysis - Disadvantage UPitt
```{r}
cgmed_model1 <- lm(grim_agediff ~ disadv_IQR + sex + age_dx + smokeHx + dich_Race + dx_IPF, data=UPitt_dnam)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + dx_IPF, data=UPitt_dnam)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="disadv_IQR", mediator="grim_agediff")
summary(med1)
```
This indicates that ~16% of the Disadvantage assoc with mortality is mediated through grim_agediff, but this effect is not significant.

### CARE
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR, data=UBC_dnam, id=ID)
summary(coxPH_model1a)
```
Disadvantage not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model1b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["disadv_IQR"])/(coxPH_model1a$coefficients["disadv_IQR"])))
med_prop
```


Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + sex + dich_Race + age_dx + dx_IPF + smokeHx, data=UBC_dnam, id=ID)
summary(coxPH_model2a)
```
Disadvantage not associated with mortality in this model.

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + sex + dich_Race + age_dx + dx_IPF + smokeHx + grim_agediff, data=UBC_dnam, id=ID)
summary(coxPH_model2b)
```
Including grim_agediff in this model increases the disadv_IQR HR, but not significant analysis

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["disadv_IQR"])/(coxPH_model2a$coefficients["disadv_IQR"])))
med_prop
```
Neither analyses are significant in the CARE-PF models, so can't rely much on this mediation proportion.

### Combined Cohorts
Unadjusted model
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + cluster(cohort), dnam, id=ID)
summary(coxPH_model1a)
```
Disadvantage is not associated with increased mortality in this model.

Unadjusted model + grim_agediff
```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model1b)
```

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model1b$coefficients["disadv_IQR"])/(coxPH_model1a$coefficients["disadv_IQR"])))
med_prop
```
Uninterpretable

Adjusted model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort), dnam, id=ID)
summary(coxPH_model2a)
```
**Disadvantage is associated with increased mortality in this model.**

Adjusted model + grim_agediff
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort) + grim_agediff, dnam, id=ID)
summary(coxPH_model2b)
```
**Including grim_agediff in this model decreases the disadv_IQR HR, suggesting that a portion of the effect of Disadvantage on mortality is mediated through methylation at grim_agediff.**

Mediation analysis
```{r}
med_prop <- (1-((coxPH_model2b$coefficients["disadv_IQR"])/(coxPH_model2a$coefficients["disadv_IQR"])))
med_prop
```
This indicates that ~21% of the association of Disadvantage with mortality may be mediated by grim_agediff in these adjusted models.

### Causal Mediation Analysis - Disadvantage Combined Cohorts
```{r}
dnamx <- dnam %>% filter(!is.na(time_DeathTxCensor))
cgmed_model1 <- lm(grim_agediff ~ disadv_IQR + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort), dnamx)
summary(cgmed_model1)
confint(cgmed_model1)
```

```{r}
med_model1 <- survreg(Surv(time_DeathTxCensor, deadORtx==1) ~ disadv_IQR + grim_agediff + sex + age_dx + smokeHx + dich_Race + dx_IPF + cluster(cohort), dnamx)
summary(med_model1)
```


```{r}
set.seed(100)
med1 <- mediation::mediate(cgmed_model1, med_model1, treat="disadv_IQR", mediator="grim_agediff")
summary(med1)
```
**This indicates that ~27% of the Disadvantage assoc with mortality is mediated through grim_agediff, and this effect is significant.**


# Forest Plots for EAD Mediation of Pollutant-Mortality Relationship
## Combined Cohorts All Pollutants
```{r}
EAD <- structure(list(mean=c(NA, NA, 2.03, 1.71, NA, 2.38, 1.98, NA, 1.47, 1.29, NA, 2.26, 1.88, NA, 1.38, 1.19, NA, 1.16, 1.07, NA, 1.64, 1.40, NA, 1.20, 1.16),
                      lower=c(NA, NA, 1.92, 1.52, NA, 2.26, 1.70, NA, 1.16, 1.21, NA, 2.06, 1.68, NA, 1.13, 1.12, NA, 1.14, 1.03, NA, 1.38, 1.38, NA, 1.17, 1.08),
                      upper=c(NA, NA, 2.14, 1.92, NA, 2.51, 2.31, NA, 1.86, 1.39, NA, 2.48, 2.11, NA, 1.68, 1.25, NA, 1.18, 1.11, NA, 1.95, 1.42, NA, 1.24, 1.23)),
                 .Names=c("mean","lower","upper"),
                 row.names=c(NA, -11L),
                 class="data.frame")

tabletext <- cbind(c("  Pollutant", "PM2.5", "Without EAD", "With EAD", "SO4", "Without EAD", "With EAD", "NO3", "Without EAD", "With EAD", "NH4", "Without EAD", "With EAD", "BC", "Without EAD", "With EAD", "OM", "Without EAD", "With EAD", "Soil", "Without EAD", "With EAD", "Disadvantage", "Without EAD", "With EAD"),
                   c("HR (95% CI)", "", "2.03 (1.92-2.14)", "1.71 (1.52-1.92)", "", "2.38 (2.26-2.51)", "1.98 (1.70-2.31)", "", "1.47 (1.16-1.86)", "1.29 (1.21-1.39)", "", "2.26 (2.06-2.48)", "1.88 (1.68-2.11)", "", "1.38 (1.13-1.68)", "1.19 (1.12-1.25)", "", "1.16 (1.14-1.18)", "1.07 (1.03-1.11)", "", "1.64 (1.38-1.95)", "1.39 (1.36-1.41)", "", "1.20 (1.17-1.24)", "1.16 (1.08-1.23)"),
                   c("P-value", "", "<0.001", "<0.001", "", "<0.001", "<0.001", "", "0.001", "<0.001", "", "<0.001", "<0.001", "", "0.001", "<0.001", "", "<0.001", "<0.001", "", "<0.001", "<0.001", "", "<0.001", "<0.001"))

styles <- fpShapesGp(
  lines=list(gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue")),
  box=list(gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"), gpar(col="royalblue"), gpar(col="royalblue"), gpar(col="lightblue"))
)

EAD %>% forestplot(labeltext = tabletext, 
             is.summary = c(rep(TRUE, 2), rep(FALSE, 2), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 2)),
             clip = c(0, 3), 
             col = fpColors(box = c("royalblue", "lightblue"),
                            line = "darkblue",
                           summary = "royalblue"),
             boxsize=0.5,
             zero=1,
             shapes_gp=styles)

```

# Bar Plots of Mediation Effects
```{r}
med <- data.frame(pollutant=c("PM2.5", "PM2.5", "SO4", "SO4", "NO3", "NO3", "NH4", "NH4", "BC", "BC", "OM", "OM", "Soil", "Soil", "Disadvantage", "Disadvantage"), med_type=c("TM","CM", "TM","CM", "TM","CM", "TM","CM", "TM","CM", "TM","CM", "TM","CM", "TM","CM"), PercentMediation=c(24, 16, 21, 11, 33, 23, 23, 14, 47, 28, 52, 30, 32, 22, 21, 26), min=c(24, 1, 21, -4, 33, -1, 23, -2, 47, -9, 52, -29, 32, 7, 21, 2), max=c(24, 37, 21, 31, 33, 39, 23, 35, 47, 48, 52, 74, 32, 38, 21, 57))
med$med_type <- factor(med$med_type, levels = c("CM", "TM"))

pollutant_levels <- c("Disadvantage", "Soil", "OM", "BC", "NH4", "NO3", "SO4", "PM2.5")
med$pollutant <- factor(med$pollutant, levels = pollutant_levels)

(ggplot(med, aes(x = pollutant, y = PercentMediation, ymin = min, ymax = max, fill = med_type)) + 
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.25) +
  ggtitle("Mediation Proportions") +
  ylim(0, 100) +
  coord_flip()+
  theme_bw())
```

# Bar Plots of Mediation Effects - No traditional mediation effect
```{r}
med <- data.frame(pollutant=c("PM2.5", "SO4", "NO3", "NH4", "BC", "OM", "Soil", "Disadvantage"), med_type=c("CM", "CM", "CM", "CM", "CM","CM","CM", "CM"), PercentMediation=c(16, 11, 23, 14, 28, 30, 22, 26), min=c(1, -4, -1, -2, -9, -29, 7, 2), max=c(37, 31, 39, 35, 48, 74, 38, 57))
med$med_type <- factor(med$med_type, levels = c("CM", "TM"))

pollutant_levels <- c("Disadvantage", "Soil", "OM", "BC", "NH4", "NO3", "SO4", "PM2.5")
med$pollutant <- factor(med$pollutant, levels = pollutant_levels)

(ggplot(med, aes(x = pollutant, y = PercentMediation, ymin = min, ymax = max, fill = med_type)) + 
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.25) +
  ggtitle("Mediation Proportions") +
  ylim(0, 100) +
  coord_flip()+
  theme_bw())
```



# Survival Sensitivity Analysis using GrimAge Acceleration (residuals)
## UPitt
### Continuous EAD
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx, data=UPitt_dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher Age_Acceleration is significantly assoc with increased mortality. Interpret this as for each 1 point increase in GrimAgeAccel, there is an 11% increased risk of mortality.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF, data=UPitt_dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**Adjusting for other covariates, there is a strong association between Age_Acceleration and mortality, indicating that for each 1 point increase in GrimAgeAccel, there is a 9% increased risk of mortality!**

Adjusted Model + Lung Function
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct, data=UPitt_dnam, id=EPIC_ID)
summary(coxPH_model3)
```
*Adjusting for other covariates + lung function, there is a marginal association between Age_Acceleration and mortality, indicating that for each 1 point increase in GrimAgeAccel, there is a 5% increased risk of mortality*


## UBC
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx, data=UBC_dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher Age_Acceleration is significantly assoc with increased mortality. Interpret this as for each 1 point increase in GrimAgeAccel, there is a 35% increased risk of mortality.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF, data=UBC_dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**Adjusting for other covariates, there is a strong association between Age_Acceleration and mortality, indicating that for each 1 point increase in GrimAgeAccel, there is a 30% increased risk of mortality!**


Adjusted Model + Lung Function
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct, data=UBC_dnam, id=EPIC_ID)
summary(coxPH_model3)
```
**Adjusting for other covariates + lung function, there is a strong association between Age_Acceleration and mortality, indicating that for each 1 point increase in GrimAgeAccel, there is a 27% increased risk of mortality**

## Combined Cohorts
Unadjusted Model
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model1)
```
**When we account for age_dx, higher Age_Acceleration is significantly assoc with increased mortality. Interpret this as for each 1 point increase in GrimAgeAccel, there is a 17% increased risk of mortality.**

Adjusted Model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + cluster(cohort), data=dnam, id=EPIC_ID)
summary(coxPH_model2)
```
**Adjusting for other covariates, there is a strong association between Age_Acceleration and mortality, indicating that for each 1 point increase in GrimAgeAccel, there is a 13% increased risk of mortality!**



Adjusted Model + Lung Function
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ Age_Acceleration + age_dx + sex + dich_Race + disadv + smokeHx + dx_IPF + fvc_pct + dlco_pct, data=dnam, id=EPIC_ID)
summary(coxPH_model3)
```
**Adjusting for other covariates, there is a strong association between Age_Acceleration and mortality, indicating that for each 1 point increase in GrimAgeAccel, there is a 9% increased risk of mortality!**

## Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
dnamx <- dnam %>% filter(!is.na(Age_Acceleration) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(cohort))

#Then make survival function
surv1 <- Surv(dnamx$time_DeathTxCensor, dnamx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(dnamx$Age_Acceleration, df=3) + cluster(dnamx$cohort))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(dnamx$Age_Acceleration, exp(predicted$fit), type="n")
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Coviariate adjusted model
```{r}
#First need to make dataframe that only includes patients with a value for event
dnamx <- dnam %>% filter(!is.na(Age_Acceleration) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(cohort) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(dx_IPF))

#Then make survival function
surv1 <- Surv(dnamx$time_DeathTxCensor, dnamx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(dnamx$Age_Acceleration, df=3) + dnamx$age_dx + dnamx$sex + dnamx$smokeHx + dnamx$dich_Race + dnamx$dx_IPF + cluster(dnamx$cohort))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(dnamx$Age_Acceleration, exp(predicted$fit), type="n")
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```


Coviariate + lung funciton adjusted model
```{r}
#First need to make dataframe that only includes patients with a value for event
dnamx <- dnam %>% filter(!is.na(Age_Acceleration) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(cohort) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(dx_IPF) &!is.na(fvc_pct) & !is.na(dlco_pct))

#Then make survival function
surv1 <- Surv(dnamx$time_DeathTxCensor, dnamx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(dnamx$Age_Acceleration, df=3) + dnamx$age_dx + dnamx$sex + dnamx$smokeHx + dnamx$dich_Race + dnamx$dx_IPF + dnamx$fvc_pct + dnamx$dlco_pct + cluster(dnamx$cohort))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(dnamx$Age_Acceleration, exp(predicted$fit), type="n")
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(dnamx$Age_Acceleration, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```


